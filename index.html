<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام التشخيص الشمولي المطور - الإصدار الحصري</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Amiri:wght@400;700&display=swap"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="expert-style.css">

    <!-- Firebase SDK (Cloud Sync Bridge) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>

<body>

    <!-- Part 1: Digital Shield & Security Layer (Hardware Locking) -->
    <div id="security-shield"
        style="position: fixed; inset: 0; background: #050505; z-index: 10000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(20px);">
        <div
            style="background: rgba(20,20,20,0.9); padding: 50px; border-radius: 40px; border: 1px solid #d4af37; box-shadow: 0 0 60px rgba(212,175,55,0.2); max-width: 550px; width: 92%; text-align: center;">
            <div style="font-size: 4rem; color: #d4af37; margin-bottom: 25px;"><i class="fas fa-microchip"></i></div>
            <h1 style="color: #fff; font-family: 'Amiri', serif; margin-bottom: 15px;">نظام الحماية والاعتماد الرقمي
            </h1>
            <p style="color: #aaa; margin-bottom: 25px; line-height: 1.6;">هذا التطبيق محمي بحقوق الملكية البرمجية لصالح
                المطور.<br>سيتم ربط هذا التطبيق **بجهازك الحالي فقط** عند التفعيل لأول مرة.</p>

            <div
                style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-bottom: 25px; border: 1px dashed #555;">
                <p style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">كود البصمة الرقمية لجهازك (Hardware ID):
                </p>
                <code id="hardware-id-display"
                    style="color: #d4af37; font-size: 1.1rem; letter-spacing: 2px;">GENERATING...</code>
            </div>

            <input type="password" id="license-key" placeholder="أدخل كود الترخيص الخاص بك"
                style="width: 100%; padding: 18px; border-radius: 12px; border: 1px solid #d4af37; background: #000; color: #fff; text-align: center; margin-bottom: 20px; font-size: 1.1rem; outline: none;">

            <button onclick="verifyAccess()"
                style="width: 100%; padding: 18px; background: #d4af37; color: #000; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; font-size: 1.1rem; transition: 0.3s; box-shadow: 0 10px 20px rgba(212,175,55,0.2);">
                <i class="fas fa-unlock-alt"></i> تفعيل الترخيص والدخول
            </button>
            <p id="security-msg" style="margin-top: 20px; color: #ff4757; font-weight: bold;"></p>
        </div>
    </div>

    <div class="expert-container">
        <header>
            <div class="logo-area">
                <img src="https://i.top4top.io/p_3708quuy81.jpg" alt="نظام التشخيص الشمولي"
                    style="border-radius: 10px;">
                <div class="app-title">
                    <h1 data-i18n="app_title">نظام التشخيص الشمولي الموسع</h1>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <p style="margin: 0;" data-i18n="academic_supervisor">المشرف الأكاديمي: د. إحسان حمدان | الإصدار
                            الاحترافي 2026</p>
                        <span id="cloud-status"
                            style="font-size: 0.75rem; background: rgba(0,255,153,0.1); color: #00ff99; padding: 2px 10px; border-radius: 20px; border: 1px solid rgba(0,255,153,0.3); display: none;">
                            <i class="fas fa-cloud-arrow-up fa-pulse"></i> متصل بالسحابة (مزامنة فورية)
                        </span>
                    </div>
                </div>
            </div>
            <div class="header-tools">
                <!-- Hidden Admin Panel (Visible only to Leila/Ihsan) -->
                <div id="admin-panel"
                    style="display: none; background: rgba(212,175,55,0.1); border: 1px solid var(--gold); padding: 10px 20px; border-radius: 12px; margin-left: 20px; align-items: center; gap: 15px;">
                    <span style="color: var(--gold); font-size: 0.8rem; font-weight: bold;"><i
                            class="fas fa-user-shield"></i> لوحة الإدارة:</span>
                    <input type="text" id="target-hwid" placeholder="أدخل HWID المريض"
                        style="background:#000; border:1px solid #444; color:#fff; padding:5px; border-radius:5px; font-size:0.8rem; width:150px;">
                    <button onclick="generateKeyForPatient()"
                        style="background:var(--gold); color:#000; border:none; padding:5px 10px; border-radius:5px; font-weight:bold; cursor:pointer; font-size:0.8rem;">توليد
                        كود التفعيل</button>
                    <code id="generated-key-display" style="color:#00ff99; font-weight:bold; font-size:0.9rem;"></code>
                </div>

                <div class="lang-switcher" style="margin-left: 15px;">
                    <select id="lang-select" onchange="changeLanguage(this.value)"
                        style="background: rgba(0,0,0,0.5); border: 1px solid var(--gold); color: #fff; padding: 8px 15px; border-radius: 8px; cursor: pointer; outline: none; font-size: 0.85rem;">
                        <option value="ar">العربية (AR)</option>
                        <option value="en">English (EN)</option>
                        <option value="fr">Français (FR)</option>
                    </select>
                </div>

                <button class="btn-premium btn-prev" onclick="window.print()"><i class="fas fa-print"></i> <span
                        data-i18n="print_report">طباعة التقرير</span></button>
            </div>
        </header>

        <div class="main-layout">
            <!-- Sidebar Nav -->
            <div class="nav-panel">
                <div class="nav-item active" onclick="showStep(1)" data-step="1"><i class="fas fa-user-md"></i> بيانات
                    الحالة</div>
                <div class="nav-item" onclick="showStep(2)" data-step="2"><i class="fas fa-droplet"></i> الفصائل الدموية
                </div>
                <div class="nav-item" onclick="showStep(3)" data-step="3"><i class="fas fa-wind"></i> نظام الطبائع</div>
                <div class="nav-item" onclick="showStep(4)" data-step="4"><i class="fas fa-microscope"></i> تشخيص
                    الأنسجة</div>
                <div class="nav-item" onclick="showStep(5)" data-step="5"><i class="fas fa-vial"></i> التشخيص الحيوي
                </div>
                <div class="nav-item" onclick="showStep(6)" data-step="6"><i class="fas fa-weight-scale"></i> التوازن
                    الفيزيائي</div>
                <div class="nav-item" onclick="showStep(7)" data-step="7"><i class="fas fa-flask"></i> القارورة والنبض
                </div>
                <div class="nav-item" onclick="showStep(8)" data-step="8"><i class="fas fa-clock"></i> الزمان والمكان
                </div>
                <div class="nav-item" onclick="showStep(9)" data-step="9"><i class="fas fa-palette"></i> الطعوم والألوان
                </div>
                <div class="nav-item" onclick="showStep(10)" data-step="10"><i class="fas fa-brain"></i> النفس والروح
                </div>
                <div class="nav-item" onclick="showStep(11)" data-step="11"><i class="fas fa-utensils"></i> الجهاز
                    الهضمي</div>
                <div class="nav-item" onclick="showStep(12)" data-step="12"><i class="fas fa-lungs"></i> الجهاز التنفسي
                </div>
                <div class="nav-item" onclick="showStep(13)" data-step="13"><i class="fas fa-heart-pulse"></i> الجهاز
                    الدموي</div>
                <div class="nav-item" onclick="showStep(14)" data-step="14"><i class="fas fa-dumbbell"></i> الجهاز
                    العضلي</div>
                <div class="nav-item" onclick="showStep(15)" data-step="15"><i class="fas fa-circle-nodes"></i> الغدة
                    الدرقية</div>
                <div class="nav-item" onclick="showStep(16)" data-step="16"><i class="fas fa-venus"></i> فحص النساء
                </div>
                <div class="nav-item" onclick="showStep(17)" data-step="17"><i class="fas fa-mars"></i> فحص الرجال</div>
                <div class="nav-item" onclick="showStep(18)" data-step="18"><i class="fas fa-flask-vial"></i> الغدد
                    والهرمونات</div>
                <div class="nav-item" onclick="showStep(19)" data-step="19"><i class="fas fa-droplet-slash"></i>
                    البرولاكتين</div>
                <div class="nav-item" onclick="showStep(20)" data-step="20"><i class="fas fa-bandage"></i> الجلطات</div>
                <div class="nav-item" onclick="showStep(21)" data-step="21"><i class="fas fa-stethoscope"></i> فحص سريري
                    شامل</div>
                <div class="nav-item" onclick="showStep(22)" data-step="22" style="background: rgba(212,175,55,0.1);"><i
                        class="fas fa-star"></i> مصدر العلة</div>
                <div id="nav-archive" class="nav-item" onclick="openArchive()"
                    style="display: none; border-top: 1px solid rgba(212,175,55,0.3); margin-top: 15px; color: var(--gold); background: rgba(0,0,0,0.3);">
                    <i class="fas fa-box-archive"></i> مركز الأرشيف المنظم
                </div>
            </div>

            <!-- Content Area -->
            <main class="content-area">

                <!-- Step 1: Basic Info -->
                <section class="diag-section active" id="step-1">
                    <h2 class="section-title"><i class="fas fa-id-card"></i> <span data-i18n="nav_basic">السجل الطبي
                            الأساسي</span></h2>
                    <div class="form-grid">
                        <div class="input-block">
                            <label data-i18n="rec_id">رقم السجل (آلي)</label>
                            <div style="display:flex; gap:10px;">
                                <input type="text" id="patient-id-input" readonly
                                    style="background: rgba(255,255,255,0.02); color: var(--gold); font-weight: bold; flex:1;">
                                <button id="id-regen-btn" onclick="generateNewPatientID()" title="تسجيل جديد"
                                    style="display:none; background:transparent; border:1px solid #444; color:#888; border-radius:8px; padding:0 10px; cursor:pointer;"><i
                                        class="fas fa-sync-alt"></i></button>
                            </div>
                        </div>
                        <div class="input-block"><label data-i18n="patient_name">اسم المريض</label><input type="text">
                        </div>
                        <div class="input-block">
                            <label data-i18n="therapist_name">اسم المعالج المشرف</label>
                            <select id="therapist-name" onchange="updateSeal()">
                                <option value="none">-- اختر المعالج --</option>
                                <option value="ihsan">د. إحسان حمدان</option>
                                <option value="leila">د. ليلى سكاك</option>
                            </select>
                        </div>
                        <div class="input-block"><label data-i18n="gender">الجنس</label><select>
                                <option data-i18n="male">ذكر</option>
                                <option data-i18n="female">أنثى</option>
                            </select></div>
                        <div class="input-block"><label data-i18n="age">العمر الفعلي</label><input type="number"></div>
                        <div class="input-block"><label data-i18n="weight">الوزن</label><input type="number"></div>
                        <div class="input-block"><label data-i18n="height">الطول</label><input type="number"></div>
                    </div>
                </section>

                <!-- Step 2: Blood Types Expanded -->
                <section class="diag-section" id="step-2">
                    <h2 class="section-title"><i class="fas fa-droplet"></i> <span data-i18n="nav_blood">تشخيص الفصائل
                            الدموية والأخلاط</span></h2>
                    <p style="margin-bottom: 20px; color: #aaa;">حدد الفصيلة ثم اختر الأعراض السلبية الملاحظة للكشف عن
                        الخلل الغذائي.</p>
                    <div class="diag-cards">
                        <div class="diag-card" onclick="selectCard(this, 'blood')"><i>A</i>
                            <h3>فصيلة A</h3>
                        </div>
                        <div class="diag-card" onclick="selectCard(this, 'blood')"><i>O</i>
                            <h3>فصيلة O</h3>
                        </div>
                        <div class="diag-card" onclick="selectCard(this, 'blood')"><i>B</i>
                            <h3>فصيلة B</h3>
                        </div>
                        <div class="diag-card" onclick="selectCard(this, 'blood')"><i>AB</i>
                            <h3>فصيلة AB</h3>
                        </div>
                    </div>

                    <!-- Rh Factor Selection -->
                    <div class="rh-container" style="margin-top: 25px; text-align: center;">
                        <h4 style="color: var(--gold); margin-bottom: 12px; font-size: 1.1rem;">تحديد عامل الريزوس (Rh
                            Factor):</h4>
                        <div style="display: flex; gap: 20px; justify-content: center;">
                            <button class="rh-btn active" id="rh-pos" onclick="selectRh(this, '+')">Rh +
                                (إيجابي)</button>
                            <button class="rh-btn" id="rh-neg" onclick="selectRh(this, '-')">Rh - (سلبي)</button>
                        </div>
                    </div>

                    <h3 style="margin-top: 30px; color: var(--gold);">الأعراض السلبية الملاحظة (خلل غذائي):</h3>
                    <div class="traits-list" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));">
                        <label class="trait-item"><input type="checkbox" onchange="updateBloodAnalysis()"> حموضة في
                            المعدة</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateBloodAnalysis()"> خمول بعد
                            الأكل</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateBloodAnalysis()"> تساقط شعر
                            مفاجئ</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateBloodAnalysis()"> غازات
                            وانتفاخات</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateBloodAnalysis()"> آلام مفاصل
                            غير مبررة</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateBloodAnalysis()"> ضيق تنفس بعد
                            وجبة</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateBloodAnalysis()"> صداع نصفي
                            متكرر</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateBloodAnalysis()"> طفح جلدي أو
                            حكة</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateBloodAnalysis()"> إمساك أو
                            إسهال مزمن</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateBloodAnalysis()"> اضطراب في
                            النوم</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateBloodAnalysis()"> تقلبات مزاجية
                            فجائية</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateBloodAnalysis()"> برودة في
                            الأطراف</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateBloodAnalysis()"> طنين في
                            الأذن</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateBloodAnalysis()"> احتباس سوائل
                            في الجسم</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateBloodAnalysis()"> رغبة ملحة في
                            السكريات</label>
                    </div>

                    <!-- Dynamic Analysis Box -->
                    <div id="blood-analysis-box"
                        style="display: none; margin-top: 30px; padding: 25px; background: rgba(212,175,55,0.05); border: 1px solid var(--gold); border-radius: 20px; animation: fadeIn 0.5s ease;">
                        <h4 style="color: var(--gold); margin-bottom: 15px; font-size: 1.2rem;"><i
                                class="fas fa-microscope"></i> التحليل المجهري الشمولي:</h4>
                        <div id="analysis-content" style="color: #eee; line-height: 1.8; font-size: 1rem;"></div>
                    </div>
                </section>

                <!-- Step 3: Deep Humoral Diagnosis (The Canon of Medicine) -->
                <section class="diag-section" id="step-3">
                    <h2 class="section-title"><i class="fas fa-microscope"></i> ميزان القوى والطبائع المزدوج</h2>
                    <p style="color: #aaa; margin-bottom: 20px;">قم بتفعيل كافة العلامات الملاحظة؛ فالتشخيص اليقيني
                        يُبنى على تراكم الأدلة في الأعضاء المختلفة.</p>

                    <div class="humor-tabs">
                        <div class="humor-step active" onclick="showHumorStep(1)" id="hstep-1">1. الجبلّة والأصل</div>
                        <div class="humor-step" onclick="showHumorStep(2)" id="hstep-2">2. المزاج الكلي</div>
                        <div class="humor-step" onclick="showHumorStep(3)" id="hstep-3">3. تتبع الأعضاء</div>
                    </div>

                    <!-- Phase 1: Innate Nature (Extensive) -->
                    <div id="humor-phase-1" class="phase-container active">
                        <h4 class="phase-title">أولاً: علامات الخلق والجبلّة الأصلية</h4>
                        <div class="traits-list" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
                            <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> مفاصل
                                بارزة وعظام صلبة (سوداوي/يابس)</label>
                            <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> عضلات
                                مفتولة وعروق واضحة (دموي/حار)</label>
                            <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> بدن رخم،
                                أبيض، قليل الشعر (بلغمي/رطب)</label>
                            <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> بشرة
                                مصفرة، عيون حادة، بنية نحيفة (صفراوي/حار)</label>
                            <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> شعر كثيف،
                                مجعد، سريع النمو (حار)</label>
                            <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> نمو بطيء
                                للشعر، سبط/ناعم (بارد)</label>
                        </div>
                    </div>

                    <!-- Phase 2: Current General Qualities (Detailed) -->
                    <div id="humor-phase-2" class="phase-container">
                        <h4 class="phase-title">ثانياً: علامات المزاج العارض (عوارض النفس والبدن)</h4>
                        <div class="traits-list">
                            <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> نوم مفرط،
                                بلادة، كسل (بارد/رطب)</label>
                            <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> أرق، كثرة
                                فكر، يقظة مفرطة (حار/يابس)</label>
                            <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> سرعة غضب،
                                حدة في الصوت (صفراوي/حار)</label>
                            <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> ضحك، سرور
                                مفرط، خفة روح (دموي)</label>
                            <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> وسواس،
                                حزن، انفعال مكتوم (سوداوي)</label>
                            <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> ملمس
                                الجلد حار جداً عند اللمس (حار)</label>
                            <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> ملمس
                                الجلد بارد كالرخام (بارد)</label>
                            <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> النبض
                                سريع، ممتلئ، قوي (دموي/حار)</label>
                            <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> النبض
                                بطيء، لين، منخفض (بلغمي/بارد)</label>
                        </div>
                    </div>

                    <!-- Phase 3: Detailed Organ Diagnosis -->
                    <div id="humor-phase-3" class="phase-container">
                        <h4 class="phase-title">ثالثاً: خارطة الأعضاء (تتبع الخلط المترسب)</h4>

                        <!-- Noble Organs -->
                        <div class="organ-group">
                            <h5><i class="fas fa-brain"></i> الدماغ والحواس (الرأس)</h5>
                            <div class="traits-list">
                                <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> ثقل
                                    مقدم الرأس مع زكام دائم (بلغمي)</label>
                                <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> صداع
                                    مع حرارة في العينين (صفراوي)</label>
                                <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()">
                                    تخيلات مخيفة وأحلام سوداء (سوداوي)</label>
                                <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> ضعف
                                    شم وتذوق مع رطوبة (بارد)</label>
                                <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> طنين
                                    أذن حاد (يابس/سوداوي)</label>
                            </div>
                        </div>

                        <!-- Heart & Chest -->
                        <div class="organ-group" style="margin-top:20px;">
                            <h5><i class="fas fa-heart"></i> القلب والصدر (الروح الحيواني)</h5>
                            <div class="traits-list">
                                <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> ضيق
                                    صدر مع برد (بلغمي)</label>
                                <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> حرارة
                                    تنفس وسرعة تواتر (حار/دموي)</label>
                                <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> خفقان
                                    عند سماع الأخبار (يبوسة/قلب)</label>
                                <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> ميل
                                    للانعزال وضيق النفس (سوداوي)</label>
                            </div>
                        </div>

                        <!-- Liver & Digestion -->
                        <div class="organ-group" style="margin-top:20px;">
                            <h5><i class="fas fa-vial"></i> الكبد والجهاز الهضمي (الأعضاء الخادمة)</h5>
                            <div class="traits-list">
                                <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> عطش
                                    شديد لا ينطفئ (حار/يابس)</label>
                                <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> شهية
                                    مفرطة مع ضعف هضم (بارد/بلغمي)</label>
                                <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> لسان
                                    أبيض رطب (بلغمي)</label>
                                <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> لسان
                                    أصفر خشن (صفراوي)</label>
                                <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> لسان
                                    أسود أو كميد (سوداوي)</label>
                                <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> بول
                                    أحمر غليظ (دموي)</label>
                                <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> بول
                                    أبيض رقيق (بلغمي)</label>
                            </div>
                        </div>

                        <!-- Extremities & Skin -->
                        <div class="organ-group" style="margin-top:20px;">
                            <h5><i class="fas fa-joint"></i> الأطراف والجلد (المنتهى)</h5>
                            <div class="traits-list">
                                <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> ترهل
                                    في اللحم والجلد (رطوبة)</label>
                                <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> خشونة
                                    وتيبس مفاصل (يبوسة)</label>
                                <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> بقع
                                    زرقاء أو سوداء تحت الجلد (سوداوي)</label>
                                <label class="trait-item"><input type="checkbox" onchange="updateHumorAnalysis()"> عروق
                                    ناتئة وبارزة جداً (حار/يابس)</label>
                            </div>
                        </div>
                    </div>

                    <!-- Humors Analysis Box -->
                    <div id="humor-analysis-box"
                        style="display: none; margin-top: 30px; padding: 25px; background: rgba(51,153,255,0.05); border: 1px solid #3399ff; border-radius: 20px;">
                        <h4 style="color: #3399ff; margin-bottom: 15px;"><i class="fas fa-scroll"></i> التحليل الموحد
                            لسيادة الخلط (خريطة المزاج):</h4>
                        <div id="humor-analysis-content" style="color: #eee; line-height: 1.8;"></div>
                    </div>
                </section>

                <!-- Step 4: Deep Tissue Diagnosis -->
                <section class="diag-section" id="step-4">
                    <h2 class="section-title"><i class="fas fa-layer-group"></i> ميزان الأنسجة الحيوية (التشخيص البنيوي)
                    </h2>
                    <p style="color: #aaa; margin-bottom: 25px;">تتبع سلامة الأنسجة يكشف عن مدى عمق العلة؛ هل هي سطحية
                        في الجلد والأغشية، أم عميقة في العظام والأعصاب؟</p>

                    <!-- Group 1: Epithelial & Membranes -->
                    <div class="organ-group">
                        <h5
                            style="color: #00d4ff; background: rgba(0,212,255,0.05); padding: 10px; border-radius: 10px;">
                            <i class="fas fa-shield-halved"></i> الأنسجة الطلائية والأغشية (المحيط)
                        </h5>
                        <div class="traits-list">
                            <label class="trait-item"><input type="checkbox" onchange="updateTissueAnalysis()"> جفاف
                                وتقشر جلدي مزمن (ضعف دهني)</label>
                            <label class="trait-item"><input type="checkbox" onchange="updateTissueAnalysis()"> تقرحات
                                في الأغشية المخاطية (الفم/المعدة)</label>
                            <label class="trait-item"><input type="checkbox" onchange="updateTissueAnalysis()"> إفرازات
                                مخاطية كثيفة (التهاب أغشية)</label>
                            <label class="trait-item"><input type="checkbox" onchange="updateTissueAnalysis()"> بهتان
                                الجلد وفقدان النضارة (سوء تروية)</label>
                            <label class="trait-item"><input type="checkbox" onchange="updateTissueAnalysis()"> حساسية
                                تلامسية سريعة</label>
                        </div>
                    </div>

                    <!-- Group 2: Connective & Structural -->
                    <div class="organ-group" style="margin-top:25px;">
                        <h5
                            style="color: #d4af37; background: rgba(212,175,55,0.05); padding: 10px; border-radius: 10px;">
                            <i class="fas fa-bone"></i> الأنسجة الضامة والهيكلية (الدعامة)
                        </h5>
                        <div class="traits-list">
                            <label class="trait-item"><input type="checkbox" onchange="updateTissueAnalysis()"> طرقعة في
                                المفاصل (نقص سائل زلالي)</label>
                            <label class="trait-item"><input type="checkbox" onchange="updateTissueAnalysis()"> هشاشة
                                وأوجاع عظمية عميقة</label>
                            <label class="trait-item"><input type="checkbox" onchange="updateTissueAnalysis()"> ترهل
                                الأربطة وسهولة الالتواء</label>
                            <label class="trait-item"><input type="checkbox" onchange="updateTissueAnalysis()"> ضخامة
                                المفصل مع احتباس سوائل</label>
                            <label class="trait-item"><input type="checkbox" onchange="updateTissueAnalysis()"> تأخر
                                التئام الجروح والتمزقات</label>
                        </div>
                    </div>

                    <!-- Group 3: Muscular & Motor -->
                    <div class="organ-group" style="margin-top:25px;">
                        <h5
                            style="color: #ff4d4d; background: rgba(255,77,77,0.05); padding: 10px; border-radius: 10px;">
                            <i class="fas fa-dumbbell"></i> الأنسجة العضلية (القوة المادية)
                        </h5>
                        <div class="traits-list">
                            <label class="trait-item"><input type="checkbox" onchange="updateTissueAnalysis()"> تشنجات
                                عضلية مفاجئة (اختلال أملاح)</label>
                            <label class="trait-item"><input type="checkbox" onchange="updateTissueAnalysis()"> وهن
                                وارتخاء عضلي عام</label>
                            <label class="trait-item"><input type="checkbox" onchange="updateTissueAnalysis()"> آلام
                                ليفية (فيبروميالغيا)</label>
                            <label class="trait-item"><input type="checkbox" onchange="updateTissueAnalysis()"> صغر حجم
                                العضلات وسرعة تعبها</label>
                            <label class="trait-item"><input type="checkbox" onchange="updateTissueAnalysis()"> انتفاخ
                                عضلي مجهول السبب</label>
                        </div>
                    </div>

                    <!-- Group 4: Nervous & Sense -->
                    <div class="organ-group" style="margin-top:25px;">
                        <h5
                            style="color: #a29bfe; background: rgba(162,155,254,0.05); padding: 10px; border-radius: 10px;">
                            <i class="fas fa-bolt"></i> الأنسجة العصبية والحسية (التحكم)
                        </h5>
                        <div class="traits-list">
                            <label class="trait-item"><input type="checkbox" onchange="updateTissueAnalysis()"> تنميل
                                وخدر في الأطراف (اعتلال عصبي)</label>
                            <label class="trait-item"><input type="checkbox" onchange="updateTissueAnalysis()"> فرط
                                حساسية للمؤثرات الصوتية والضوئية</label>
                            <label class="trait-item"><input type="checkbox" onchange="updateTissueAnalysis()"> حرقان في
                                المسارات العصبية</label>
                            <label class="trait-item"><input type="checkbox" onchange="updateTissueAnalysis()"> بطء
                                استجابة الفعل المنعكس</label>
                            <label class="trait-item"><input type="checkbox" onchange="updateTissueAnalysis()"> ارتعاش
                                لا إرادي في الجفون أو الأصابع</label>
                        </div>
                    </div>

                    <!-- Tissue Analysis Box -->
                    <div id="tissue-analysis-box"
                        style="display: none; margin-top: 30px; padding: 25px; background: rgba(162,155,254,0.05); border: 1px solid #a29bfe; border-radius: 20px;">
                        <h4 style="color: #a29bfe; margin-bottom: 15px;"><i class="fas fa-microchip"></i> تحليل الحالة
                            البنيوية للأنسجة:</h4>
                        <div id="tissue-analysis-content" style="color: #eee; line-height: 1.8;"></div>
                    </div>
                </section>

                <!-- Step 5: Advanced Vital Diagnosis (Bio-Metrics) -->
                <section class="diag-section" id="step-5">
                    <h2 class="section-title"><i class="fas fa-vial-circle-check"></i> الميزان الحيوي والمقاييس
                        (Bio-Metrics)</h2>
                    <p style="color: #aaa; margin-bottom: 25px;">قياس المؤشرات الحيوية بدقة يحدد "القوة المدبرة" للبدن
                        ومدى قدرتها على المقاومة والتعافي.</p>

                    <div class="form-grid">
                        <!-- Oxygen & Blood -->
                        <div class="input-block">
                            <label><i class="fas fa-lungs"></i> كفاءة الأكسجة الحيوية</label>
                            <select onchange="updateVitalAnalysis()" id="vital-ox">
                                <option value="normal">أكسجة ممتازة (100%-95%)</option>
                                <option value="low">أكسجة منخفضة (تحت 95%) - نقص تروية</option>
                                <option value="critical">نقص حاد - علامة ركود خلطي</option>
                            </select>
                        </div>
                        <div class="input-block">
                            <label><i class="fas fa-droplet"></i> قوام وسلامة الدم</label>
                            <select onchange="updateVitalAnalysis()" id="vital-blood">
                                <option value="balanced">متوازن وناصع</option>
                                <option value="thick">ثقيل ولزج (سوداوي/دموي)</option>
                                <option value="thin">رقيق ومائي (بلغمي)</option>
                                <option value="dark">داكن ومحترق (صفراوي محترق)</option>
                            </select>
                        </div>
                    </div>

                    <h4 style="color: var(--gold); margin: 25px 0 15px;">مؤشرات الميزان الكيميائي الحيوي:</h4>
                    <div class="traits-list" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
                        <label class="trait-item"><input type="checkbox" onchange="updateVitalAnalysis()"> اختلال توازن
                            الأملاح (صوديوم/بوتاسيوم)</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateVitalAnalysis()"> نقص
                            كلسيوم/ماغنسيوم (تشنجات بنيوية)</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateVitalAnalysis()"> اضطراب
                            الأحماض الأمينية (بناء نسيجي ضعيف)</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateVitalAnalysis()"> وجود مركبات
                            كيميائية غريبة (سموم بيئية)</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateVitalAnalysis()"> ميل للوسط
                            الحمضي (التهابات مستمرة)</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateVitalAnalysis()"> ضعف كفاءة
                            الأنزيمات الهاضمة</label>
                    </div>

                    <!-- Vital Analysis Box -->
                    <div id="vital-analysis-box"
                        style="display: none; margin-top: 30px; padding: 25px; background: rgba(0,255,153,0.05); border: 1px solid #00ff99; border-radius: 20px;">
                        <h4 style="color: #00ff99; margin-bottom: 15px;"><i class="fas fa-chart-line"></i> تقرير الكفاءة
                            الحيوية (Bio-Efficiency):</h4>
                        <div id="vital-analysis-content" style="color: #eee; line-height: 1.8;"></div>
                    </div>
                </section>

                <!-- Step 6: Physical Balance & BMI -->
                <section class="diag-section" id="step-6">
                    <h2 class="section-title"><i class="fas fa-weight-scale"></i> ميزان الاعتدال الفيزيائي (الكتلة
                        والبنية)</h2>
                    <p style="color: #aaa; margin-bottom: 25px;">تحديد مؤشر كتلة الجسم وعلاقة الطول بالوزن يكشف عن
                        "حمولة البدن" ومدى ملاءمتها للمزاج الأصلي.</p>

                    <div class="form-grid">
                        <div class="input-block">
                            <label><i class="fas fa-weight-hanging"></i> الوزن (كجم)</label>
                            <input type="number" id="physical-weight" oninput="updatePhysicalAnalysis()"
                                placeholder="00">
                        </div>
                        <div class="input-block">
                            <label><i class="fas fa-ruler-vertical"></i> الطول (سم)</label>
                            <input type="number" id="physical-height" oninput="updatePhysicalAnalysis()"
                                placeholder="000">
                        </div>
                        <div class="input-block">
                            <label><i class="fas fa-circle-dot"></i> محيط الخصر (سم)</label>
                            <input type="number" id="physical-waist" oninput="updatePhysicalAnalysis()"
                                placeholder="00">
                        </div>
                    </div>

                    <div class="organ-group" style="margin-top:20px;">
                        <h5><i class="fas fa-person-walking-arrow-right"></i> علامات البنية المشاهدة:</h5>
                        <div class="traits-list">
                            <label class="trait-item"><input type="checkbox" onchange="updatePhysicalAnalysis()"> بنية
                                عظمية ضخمة (دموي/بلغمي)</label>
                            <label class="trait-item"><input type="checkbox" onchange="updatePhysicalAnalysis()"> بنية
                                عظمية دقيقة (صفراوي/سوداوي)</label>
                            <label class="trait-item"><input type="checkbox" onchange="updatePhysicalAnalysis()"> ترهل
                                شحمي في منطقة البطن (برودة هضمية)</label>
                            <label class="trait-item"><input type="checkbox" onchange="updatePhysicalAnalysis()"> صلابة
                                عضلية واضحة (حرارة بدنية)</label>
                        </div>
                    </div>

                    <!-- Physical Analysis Box -->
                    <div id="physical-analysis-box"
                        style="display: none; margin-top: 30px; padding: 25px; background: rgba(212,175,55,0.05); border: 1px solid var(--gold); border-radius: 20px;">
                        <h4 style="color: var(--gold); margin-bottom: 15px;"><i class="fas fa-calculator"></i> تحليل
                            التوازن الفيزيائي والكتلة:</h4>
                        <div id="physical-analysis-content" style="color: #eee; line-height: 1.8;"></div>
                    </div>
                </section>

                <!-- Step 7: Deep Bottle & Pulse Diagnosis (Al-Qarura wa Al-Nabdh) -->
                <section class="diag-section" id="step-7">
                    <h2 class="section-title"><i class="fas fa-heart-pulse"></i> علم الاستدلال بالقارورة والنبض</h2>
                    <p style="color: #aaa; margin-bottom: 25px;">هذان هما "ميزانا العدل" في كشف أحوال الكبد (عبر البول)
                        وأحوال القلب (عبر النبض).</p>

                    <div class="grid-2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <!-- Pulse Diagnosis -->
                        <div class="organ-group">
                            <h5 style="color: #ff4d4d;"><i class="fas fa-heartbeat"></i> أحوال النبض (استدلال القلب)
                            </h5>
                            <div class="input-block">
                                <label>مقدار الانتفاخ (عريض/ضيق)</label>
                                <select onchange="updatePulseBottleAnalysis()" id="pulse-size">
                                    <option value="normal">معتدل</option>
                                    <option value="large">عريض وعظيم (حرارة مفرطة)</option>
                                    <option value="small">ضيق وصغير (برودة/يبوسة)</option>
                                </select>
                            </div>
                            <div class="input-block">
                                <label>سرعة التواتر (سريع/بطيء)</label>
                                <select onchange="updatePulseBottleAnalysis()" id="pulse-speed">
                                    <option value="normal">معتدل</option>
                                    <option value="fast">سريع (حميات/غضب/حرارة)</option>
                                    <option value="slow">بطيء (رطوبة/بلغم/ضعف)</option>
                                </select>
                            </div>
                            <div class="input-block">
                                <label>قوام الوعاء (صلب/لين)</label>
                                <select onchange="updatePulseBottleAnalysis()" id="pulse-touch">
                                    <option value="normal">لين ومعتدل</option>
                                    <option value="hard">صلب كالحبل (يبوسة سوداوية)</option>
                                    <option value="soft">لين جداً (رطوبة بلغمية)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Bottle Diagnosis -->
                        <div class="organ-group">
                            <h5 style="color: #00d4ff;"><i class="fas fa-flask"></i> أحوال القارورة (استدلال الكبد)</h5>
                            <div class="input-block">
                                <label>اللون (الأصباغ)</label>
                                <select onchange="updatePulseBottleAnalysis()" id="urine-color">
                                    <option value="straw">تبني معتدل</option>
                                    <option value="red">أحمر/ناري (غلبة الدم)</option>
                                    <option value="yellow">أصفر فاقع (غلبة الصفراء)</option>
                                    <option value="white">أبيض لبني (غلبة البلغم)</option>
                                    <option value="dark">داكن/كمد (سيادة السوداء)</option>
                                </select>
                            </div>
                            <div class="input-block">
                                <label>القوام (الكثافة)</label>
                                <select onchange="updatePulseBottleAnalysis()" id="urine-density">
                                    <option value="normal">معتدل</option>
                                    <option value="thick">غليظ (سوء هضم/أخلاط لزجة)</option>
                                    <option value="thin">رقيق مائي (ضعف النضج الخلطي)</option>
                                </select>
                            </div>
                            <div class="input-block">
                                <label>الرسوب (الثفل)</label>
                                <select onchange="updatePulseBottleAnalysis()" id="urine-sediment">
                                    <option value="none">صافي</option>
                                    <option value="cloudy">كدر/غيوم (اضطراب الرياح)</option>
                                    <option value="sandy">رسوب رملي (رمل كلي/سوء استقلاب)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Pulse/Bottle Analysis Box -->
                    <div id="pb-analysis-box"
                        style="display: none; margin-top: 30px; padding: 25px; background: rgba(255,102,102,0.05); border: 1px solid #ff6666; border-radius: 20px;">
                        <h4 style="color: #ff6666; margin-bottom: 15px;"><i class="fas fa-stethoscope"></i> خلاصة
                            الدلالة (القلب والكبد):</h4>
                        <div id="pb-analysis-content" style="color: #eee; line-height: 1.8;"></div>
                    </div>
                </section>

                <!-- Step 8: Environmental & Temporal Diagnosis (Az-Zaman wa Al-Makan) -->
                <section class="diag-section" id="step-8">
                    <h2 class="section-title"><i class="fas fa-map-location-dot"></i> ميزان الزمان والمكان (تأثير
                        المحيط)</h2>
                    <p style="color: #aaa; margin-bottom: 25px;">الإنسان ابن بيئته؛ فالفصل والوقت والمكان تحدد مدى
                        استجابة "القوة الغازية" والمحيط الحيوي للبدن.</p>

                    <div class="form-grid">
                        <div class="input-block">
                            <label><i class="fas fa-clock"></i> توقيت زيادة العلة</label>
                            <select onchange="updateTimePlaceAnalysis()" id="env-time">
                                <option value="dawn">الفجر والصباح الباكر (وقت البلغم)</option>
                                <option value="noon">الظهيرة (وقت الصفراء)</option>
                                <option value="evening">العصر والغروب (وقت السوداء)</option>
                                <option value="night">الليل (وقت الدم/الرطوبة)</option>
                            </select>
                        </div>
                        <div class="input-block">
                            <label><i class="fas fa-calendar-alt"></i> الفصل الحالي / زيادة الأعراض</label>
                            <select onchange="updateTimePlaceAnalysis()" id="env-season">
                                <option value="spring">الربيع (حار رطب - وقت الدم)</option>
                                <option value="summer">الصيف (حار يابس - وقت الصفراء)</option>
                                <option value="autumn">الخريف (بارد يابس - وقت السوداء)</option>
                                <option value="winter">الشتاء (بارد رطب - وقت البلغم)</option>
                            </select>
                        </div>
                        <div class="input-block">
                            <label><i class="fas fa-mountain-sun"></i> طبيعة المكان الجغرافي</label>
                            <select onchange="updateTimePlaceAnalysis()" id="env-geo">
                                <option value="sea">ساحلي/بحري (رطوبة عالية)</option>
                                <option value="mountain">جبلي/مرتفع (برد ويبوسة)</option>
                                <option value="desert">صحراوي (حرارة ويبوسة)</option>
                                <option value="urban">مدني/مزدحم (تلوث وأخلاط غريبة)</option>
                            </select>
                        </div>
                        <div class="input-block">
                            <label><i class="fas fa-wind"></i> الحالة الجوية المحيطة</label>
                            <select onchange="updateTimePlaceAnalysis()" id="env-atmos">
                                <option value="normal">معتدلة</option>
                                <option value="humid">رطوبة شديدة (تراكم بلغمي)</option>
                                <option value="dry">جفاف واحتباس (تحفيز السوداء)</option>
                                <option value="windy">رياح وعواصف (تهيج الصفراء/النفخة)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Environmental Analysis Box -->
                    <div id="env-analysis-box"
                        style="display: none; margin-top: 30px; padding: 25px; background: rgba(255,153,51,0.05); border: 1px solid #ff9933; border-radius: 20px;">
                        <h4 style="color: #ff9933; margin-bottom: 15px;"><i class="fas fa-smog"></i> تأثير المجال المحيط
                            (Environmental Impact):</h4>
                        <div id="env-analysis-content" style="color: #eee; line-height: 1.8;"></div>
                    </div>
                </section>

                <!-- Step 9: Tastes & Colors (At-To'oom wa Al-Alwan) -->
                <section class="diag-section" id="step-9">
                    <h2 class="section-title"><i class="fas fa-palette"></i> ميزان الطعوم والألوان (الشهوة والاستجابة)
                    </h2>
                    <p style="color: #aaa; margin-bottom: 25px;">شهوات البدن للطعوم وميله للألوان ليست عشوائية؛ بل هي
                        "نداء استغاثة" من الأعضاء لتعويض نقص أو تعديل مزاج.</p>

                    <div class="grid-2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <!-- Tastes Selection -->
                        <div class="organ-group">
                            <h5 style="color: #f1c40f;"><i class="fas fa-utensils"></i> الميول للطعوم (الشهوة الغذائية)
                            </h5>
                            <div class="traits-list" style="grid-template-columns: 1fr;">
                                <label class="trait-item"><input type="checkbox" onchange="updateTasteColorAnalysis()"
                                        value="sweet"> الحلاوة المفرطة (طلب الطاقة/الدم)</label>
                                <label class="trait-item"><input type="checkbox" onchange="updateTasteColorAnalysis()"
                                        value="bitter"> المرارة (طلب التنقية/الكبد)</label>
                                <label class="trait-item"><input type="checkbox" onchange="updateTasteColorAnalysis()"
                                        value="salty"> الملوحة (طلب المعادن/تعديل اليبوسة)</label>
                                <label class="trait-item"><input type="checkbox" onchange="updateTasteColorAnalysis()"
                                        value="sour"> الحموضة (طلب التبريد/قطع البلغم)</label>
                                <label class="trait-item"><input type="checkbox" onchange="updateTasteColorAnalysis()"
                                        value="pungent"> الحرافة والحرارة (طلب التحريك/البرد)</label>
                            </div>
                        </div>

                        <!-- Colors Selection -->
                        <div class="organ-group">
                            <h5 style="color: #9b59b6;"><i class="fas fa-eye"></i> الميول للألوان (الاستجابة النفسية)
                            </h5>
                            <div class="traits-list" style="grid-template-columns: 1fr;">
                                <label class="trait-item"><input type="checkbox" onchange="updateTasteColorAnalysis()"
                                        value="red"> الأحمر (إثارة القوة الدموية)</label>
                                <label class="trait-item"><input type="checkbox" onchange="updateTasteColorAnalysis()"
                                        value="yellow"> الأصفر (تحفيز الكيس الصفراوي)</label>
                                <label class="trait-item"><input type="checkbox" onchange="updateTasteColorAnalysis()"
                                        value="blue"> الأزرق/الأبيض (تهدئة الحرارة/البلغم)</label>
                                <label class="trait-item"><input type="checkbox" onchange="updateTasteColorAnalysis()"
                                        value="dark"> الأسود/الداكن (الانكماش السوداوي)</label>
                            </div>
                        </div>
                    </div>

                    <!-- Taste/Color Analysis Box -->
                    <div id="tc-analysis-box"
                        style="display: none; margin-top: 30px; padding: 25px; background: rgba(155,89,182,0.05); border: 1px solid #9b59b6; border-radius: 20px;">
                        <h4 style="color: #9b59b6; margin-bottom: 15px;"><i class="fas fa-magic"></i> دلالة الشهوات
                            واللون (Insight):</h4>
                        <div id="tc-analysis-content" style="color: #eee; line-height: 1.8;"></div>
                    </div>
                </section>

                <!-- Step 10: Psycho-Spiritual & Neuro-Metaphysical -->
                <section class="diag-section" id="step-10">
                    <h2 class="section-title"><i class="fas fa-brain"></i> الميزان النفسي والروحي (الخفايـا)</h2>
                    <p style="color: #aaa; margin-bottom: 25px;">الإنسان كائن مركب من (جسد، نفس، وروح). أي خلل في
                        العوامل الروحية أو الهرمونية ينعكس فوراً كعلة بدنية لا تبرأ بالعلاجات المادية وحدها.</p>

                    <!-- Part A: Neuro-Hormonal (The Physiological Interface) -->
                    <div class="organ-group">
                        <h4 style="color: #a29bfe; margin-bottom: 15px;"><i class="fas fa-microchip"></i> أولاً: الميزان
                            العصبي الهرموني (Neuro-Hormonal)</h4>
                        <div class="traits-list">
                            <label class="trait-item"><input type="checkbox" onchange="updatePsychoSpiritualAnalysis()">
                                انخفاض الدوبامين (فقدان الشغف/بلادة)</label>
                            <label class="trait-item"><input type="checkbox" onchange="updatePsychoSpiritualAnalysis()">
                                اضطراب السيروتونين (قلق/وسواس/حزن)</label>
                            <label class="trait-item"><input type="checkbox" onchange="updatePsychoSpiritualAnalysis()">
                                فرط الكورتيزول (إجهاد مزمن/ضغط كظري)</label>
                            <label class="trait-item"><input type="checkbox" onchange="updatePsychoSpiritualAnalysis()">
                                اختلال هرمونات الغدة الدرقية (برودة/حرارة تمثيلية)</label>
                            <label class="trait-item"><input type="checkbox" onchange="updatePsychoSpiritualAnalysis()">
                                اضطراب الهرمونات الأنثوية/الذكرية (تقلب مزاجي دوري)</label>
                        </div>
                    </div>

                    <!-- Part B: Spiritual Diagnosis (The Metaphysical) -->
                    <div class="organ-group" style="margin-top:30px;">
                        <h4 style="color: #ff9f43; margin-bottom: 15px;"><i class="fas fa-eye-slash"></i> ثانياً:
                            الاستدلال الروحي (الإصابات الغيبية)</h4>

                        <!-- Magic (Sihr) Section -->
                        <div
                            style="background: rgba(255,159,67,0.05); padding: 15px; border-radius: 15px; margin-bottom: 15px;">
                            <h5 style="color: #ff9f43;"><i class="fas fa-scroll"></i> نوع السحر (إن وجد)</h5>
                            <div class="traits-list">
                                <label class="trait-item"><input type="checkbox"
                                        onchange="updatePsychoSpiritualAnalysis()"> سحر مأكول/مشروب (آلام بطن
                                    دائمة/استفراغ)</label>
                                <label class="trait-item"><input type="checkbox"
                                        onchange="updatePsychoSpiritualAnalysis()"> سحر مرشوش/مخطي (آلام أقدام وثقل
                                    مفاجئ)</label>
                                <label class="trait-item"><input type="checkbox"
                                        onchange="updatePsychoSpiritualAnalysis()"> سحر مشموم (صداع متنقل وضيق
                                    تنفس)</label>
                                <label class="trait-item"><input type="checkbox"
                                        onchange="updatePsychoSpiritualAnalysis()"> سحر مدفون/معلق (خمول شديد وتوقف
                                    حال)</label>
                            </div>
                        </div>

                        <!-- Evil Eye & Envy Section -->
                        <div
                            style="background: rgba(255,71,87,0.05); padding: 15px; border-radius: 15px; margin-bottom: 15px;">
                            <h5 style="color: #ff4757;"><i class="fas fa-eye"></i> العين والحسد</h5>
                            <div class="traits-list">
                                <label class="trait-item"><input type="checkbox"
                                        onchange="updatePsychoSpiritualAnalysis()"> عين حقودة/حاسدة (خمول، تثاؤب، بقع
                                    زرقاء)</label>
                                <label class="trait-item"><input type="checkbox"
                                        onchange="updatePsychoSpiritualAnalysis()"> عين معجبة (تعطل الميزة المعجب بها:
                                    شعر، ذكاء، جمال)</label>
                                <label class="trait-item"><input type="checkbox"
                                        onchange="updatePsychoSpiritualAnalysis()"> حسد على النعم (تلف مفاجئ في
                                    الممتلكات أو الرزق)</label>
                            </div>
                        </div>

                        <!-- Possession Section -->
                        <div style="background: rgba(112,161,255,0.05); padding: 15px; border-radius: 15px;">
                            <h5 style="color: #70a1ff;"><i class="fas fa-ghost"></i> المس والعوارض</h5>
                            <div class="traits-list">
                                <label class="trait-item"><input type="checkbox"
                                        onchange="updatePsychoSpiritualAnalysis()"> مس طائف/عارض (صرع أو غيبوبة
                                    لحظية)</label>
                                <label class="trait-item"><input type="checkbox"
                                        onchange="updatePsychoSpiritualAnalysis()"> مس عاشق (أرق، كوابيس لا أخلاقية، ضيق
                                    من الزواج)</label>
                                <label class="trait-item"><input type="checkbox"
                                        onchange="updatePsychoSpiritualAnalysis()"> مس انتقامي (آلام شديدة متنقلة لا سبب
                                    طبي لها)</label>
                            </div>
                        </div>
                    </div>

                    <!-- Psycho-Spiritual Analysis Box -->
                    <div id="ps-analysis-box"
                        style="display: none; margin-top: 30px; padding: 25px; background: rgba(162,155,254,0.05); border: 1px solid #a29bfe; border-radius: 20px;">
                        <h4 style="color: #a29bfe; margin-bottom: 15px;"><i class="fas fa-sparkles"></i> كشف المستور
                            (التحليل النفسي-الروحي):</h4>
                        <div id="ps-analysis-content" style="color: #eee; line-height: 1.8;"></div>
                    </div>
                </section>

                <!-- Step 11: Digestive System (Clinical) -->
                <section class="diag-section" id="step-11">
                    <h2 class="section-title"><i class="fas fa-utensils"></i> الجهاز الهضمي والتمثيل</h2>
                    <div class="traits-list" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
                        <label class="trait-item"><input type="checkbox" onchange="updateDigestiveAnalysis()"> عسر هضم
                            وتخمر (أخلاط نيئة)</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateDigestiveAnalysis()"> غازات
                            وانتفاخات (رياح غليظة)</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateDigestiveAnalysis()"> إمساك
                            مزمن (يبوسة معوية)</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateDigestiveAnalysis()"> إسهال
                            متكرر (برودة/رطوبة)</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateDigestiveAnalysis()"> حموضة
                            وحرقان (حدة صفراوية)</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateDigestiveAnalysis()"> آلام في
                            فم المعدة</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateDigestiveAnalysis()"> قولون
                            عصبي وشد بطني</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateDigestiveAnalysis()"> طعم مر في
                            الفم (هيجان الصفراء)</label>
                    </div>
                </section>

                <!-- Step 12: Respiratory System (Clinical) -->
                <section class="diag-section" id="step-12">
                    <h2 class="section-title"><i class="fas fa-lungs"></i> الجهاز التنفسي (الترويح)</h2>
                    <div class="traits-list" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
                        <label class="trait-item"><input type="checkbox" onchange="updateRespiratoryAnalysis()"> ضيق
                            تنفس (ربو/حساسية)</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateRespiratoryAnalysis()"> سعال
                            جاف (يبوسة الرئة)</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateRespiratoryAnalysis()"> سعال
                            بلغمي (رطوبة باردة)</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateRespiratoryAnalysis()"> تحسس
                            وضيق عند الغبار أو الروائح</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateRespiratoryAnalysis()"> آلام في
                            الصدر عند التنفس العميق</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateRespiratoryAnalysis()"> التهاب
                            جيوب أنفية مزمن</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateRespiratoryAnalysis()"> شخير
                            واختناق أثناء النوم</label>
                    </div>
                </section>

                <!-- Step 13: Circulatory System (Clinical) -->
                <section class="diag-section" id="step-13">
                    <h2 class="section-title"><i class="fas fa-heart-pulse"></i> الجهاز الدموي والوعائي</h2>
                    <div class="traits-list" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
                        <label class="trait-item"><input type="checkbox" onchange="updateCirculatoryAnalysis()"> خفقان
                            وتسارع ضربات القلب</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateCirculatoryAnalysis()"> ضغط دم
                            مرتفع (امتلاء)</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateCirculatoryAnalysis()"> ضغط دم
                            منخفض (ضعف القوة)</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateCirculatoryAnalysis()"> برودة
                            شديدة في الأطراف</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateCirculatoryAnalysis()"> دوخة
                            ودوار عند تغيير الوضعية</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateCirculatoryAnalysis()"> تورم
                            القدمين (احتباس دموي)</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateCirculatoryAnalysis()"> ظهور
                            دوالي الساقين (ركود سوداوي)</label>
                    </div>
                </section>

                <!-- Step 14: Muscular System (Clinical) -->
                <section class="diag-section" id="step-14">
                    <h2 class="section-title"><i class="fas fa-dumbbell"></i> الجهاز العضلي والحركي</h2>
                    <div class="traits-list" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
                        <label class="trait-item"><input type="checkbox" onchange="updateMuscularAnalysis()"> تشنجات
                            عضلية متكررة (شد عضلي)</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateMuscularAnalysis()"> وهن وضعف
                            في الكتلة العضلية</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateMuscularAnalysis()"> آلام ليفية
                            منتشرة (فيبروميالغيا)</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateMuscularAnalysis()"> ارتعاش لا
                            إرادي في الألياف العضلية</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateMuscularAnalysis()"> صعوبة في
                            صعود الدرج أو المشي</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateMuscularAnalysis()"> ثقل عام في
                            العظام والمفاصل</label>
                    </div>
                </section>

                <!-- Step 15: Thyroid Gland (Detailed) -->
                <section class="diag-section" id="step-15">
                    <h2 class="section-title"><i class="fas fa-circle-nodes"></i> استقصاء الغدة الدرقية</h2>
                    <div class="traits-list" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
                        <label class="trait-item"><input type="checkbox" onchange="updateThyroidAnalysis()"> خمول ونعاس
                            مفرط (خمول الغدة)</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateThyroidAnalysis()"> زيادة وزن
                            غير مبررة</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateThyroidAnalysis()"> نقص وزن
                            مفاجئ وجحوظ عينين</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateThyroidAnalysis()"> تساقط شعر
                            وتقصف الأظافر</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateThyroidAnalysis()"> جفاف شديد
                            في الجلد</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateThyroidAnalysis()"> عصبية وقلق
                            مفرط (نشاط الغدة)</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateThyroidAnalysis()"> عدم تحمل
                            البرودة نهائياً</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateThyroidAnalysis()"> عدم تحمل
                            الحرارة والتعرق المفرط</label>
                    </div>
                </section>

                <!-- Step 16: Women's Health (OBGYN) -->
                <section class="diag-section" id="step-16">
                    <h2 class="section-title"><i class="fas fa-venus"></i> فحص استقصاء النساء (الدورة والثدي)</h2>
                    <div class="traits-list" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
                        <label class="trait-item"><input type="checkbox" onchange="updateWomenAnalysis()"> اضطراب أو
                            انقطاع في الدورة الشهرية</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateWomenAnalysis()"> آلام حادة
                            وتشنجات رحمية شديدة</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateWomenAnalysis()"> نزيف دموي
                            غزير ومستمر</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateWomenAnalysis()"> وجود كتل أو
                            تحجر في الثدي</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateWomenAnalysis()"> وخز وأوجاع في
                            الثدي قبل الدورة</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateWomenAnalysis()"> إفرازات
                            مهبلية غير طبيعية (رطوبة فاسدة)</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateWomenAnalysis()"> تكيس المبايض
                            (ترسب بلغمي/سوداوي)</label>
                    </div>
                </section>

                <!-- Step 17: Men's Health -->
                <section class="diag-section" id="step-17">
                    <h2 class="section-title"><i class="fas fa-mars"></i> فحص استقصاء الرجال</h2>
                    <div class="traits-list" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
                        <label class="trait-item"><input type="checkbox" onchange="updateMenAnalysis()"> ضعف طاقة عام
                            وإجهاد حاد</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateMenAnalysis()"> أعراض تضخم
                            البروستاتا (صعوبة تبول)</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateMenAnalysis()"> آلام في أسفل
                            الحوض والخصيتين</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateMenAnalysis()"> تكرار التبول
                            الليلي (برودة المثانة)</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateMenAnalysis()"> ضعف الرغبة
                            الكلية (نقص الحرارة الغريزية)</label>
                    </div>
                </section>

                <!-- Step 18: Endocrine & Hormones -->
                <section class="diag-section" id="step-18">
                    <h2 class="section-title"><i class="fas fa-flask-vial"></i> الغدد الصماء والهرمونات</h2>
                    <div class="traits-list" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
                        <label class="trait-item"><input type="checkbox" onchange="updateEndocrineAnalysis()"> كثرة
                            التبول مع عطش دائم (مؤشر سكري)</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateEndocrineAnalysis()"> هبات
                            ساخنة مفاجئة (اضطراب هرموني)</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateEndocrineAnalysis()"> اضطرابات
                            نوم عميقة وأرق هرموني</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateEndocrineAnalysis()"> تعرق ليلي
                            غزير ومستمر</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateEndocrineAnalysis()"> ظهور شعر
                            غير مرغوب فيه (عند النساء)</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateEndocrineAnalysis()"> تصبغات
                            جلدية في الرقبة أو الثنيات</label>
                    </div>
                </section>

                <!-- Step 19: Prolactin (Hormone) -->
                <section class="diag-section" id="step-19">
                    <h2 class="section-title"><i class="fas fa-droplet-slash"></i> استقصاء هرمون الحليب (البرولاكتين)
                    </h2>
                    <div class="traits-list" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
                        <label class="trait-item"><input type="checkbox" onchange="updateProlactinAnalysis()"> إفرازات
                            من الحلمتين (بدون رضاعة)</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateProlactinAnalysis()"> صداع شديد
                            في مقدمة الرأس (الغدة النخامية)</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateProlactinAnalysis()"> اضطراب في
                            الرؤية أو المجال البصري</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateProlactinAnalysis()"> تأخر
                            الحمل بدون سبب عضلي واضح</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateProlactinAnalysis()"> انخفاض
                            ملحوظ في كثافة العظام</label>
                    </div>
                </section>

                <!-- Step 20: Blood Clots & Thrombosis -->
                <section class="diag-section" id="step-20">
                    <h2 class="section-title"><i class="fas fa-bandage"></i> تقييم مخاطر الجلطات (الركود الدموي)</h2>
                    <div class="traits-list" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
                        <label class="trait-item"><input type="checkbox" onchange="updateClotsAnalysis()"> ألم مفاجئ
                            وشديد في عضلة الساق</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateClotsAnalysis()"> تورم واحمرار
                            وسخونة في جهة واحدة من الساق</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateClotsAnalysis()"> ضيق تنفس
                            مفاجئ وغير مفسر</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateClotsAnalysis()"> آلام حادة في
                            الصدر تزداد مع التنفس</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateClotsAnalysis()"> تنميل ثقيل في
                            جهة واحدة من الوجه أو الجسم</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateClotsAnalysis()"> تاريخ عائلي
                            سابق لجلطات الأوردة</label>
                    </div>
                </section>

                <!-- Step 21: Full Systemic Clinical Exam -->
                <section class="diag-section" id="step-21">
                    <h2 class="section-title"><i class="fas fa-stethoscope"></i> الفحص السريري الشامل (المشاهدة)</h2>
                    <div class="traits-list" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
                        <label class="trait-item"><input type="checkbox" onchange="updateExamAnalysis()"> شحوب شديد في
                            الوجه (فقر دم/برودة)</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateExamAnalysis()"> اصفرار في بياض
                            العينين</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateExamAnalysis()"> هالات سوداء
                            عميقة تحت العينين (إجهاد كلى)</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateExamAnalysis()"> جفاف وتشقق في
                            زوايا الشفاه</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateExamAnalysis()"> رائحة فم كريهة
                            (رطوبة معدية فاسدة)</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateExamAnalysis()"> تضخم واضح في
                            العقد الليمفاوية</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateExamAnalysis()"> برودة أو تعرق
                            مفرط في راحة اليدين</label>
                        <label class="trait-item"><input type="checkbox" onchange="updateExamAnalysis()"> مشاكل في
                            التوازن أو المشية</label>
                    </div>
                </section>

                <!-- Step 22: Final Source of Ailment (Asl Al-Ella) -->
                <section class="diag-section" id="step-22">
                    <h2 class="section-title" style="color: #fff;"><i class="fas fa-award"></i> ميزان الحقيقة (مصدر
                        العلة النهائي)</h2>
                    <p style="color: #aaa; margin-bottom: 25px;">هنا يجتمع العلم الغزي بالاستدلال القلبي؛ لتحديد "العروة
                        الوثقى" للمرض والبدء في صياغة البروتوكول العلاجي.</p>

                    <!-- Evidence Synthesis Dashboard -->
                    <div id="final-evidence-dashboard"
                        style="background: rgba(255,255,255,0.03); border: 1px solid rgba(212,175,55,0.3); border-radius: 20px; padding: 25px; margin-bottom: 30px;">
                        <h4 style="color: var(--gold); margin-bottom: 20px;"><i class="fas fa-list-check"></i> لوحة
                            تجميع الأدلة المكتشفة:</h4>
                        <div id="evidence-summary-list"
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; color: #eee; font-size: 0.95rem;">
                            <!-- Dynamically populated by generateFinalReport() -->
                            <p style="color: #888;">قم بالضغط على زر "توليد الخلاصة" لتجميع كافة البيانات المكتشفة من
                                الأقسام العشرة السابقة...</p>
                        </div>
                        <button onclick="generateFinalReport()"
                            style="margin-top:20px; padding:12px 25px; background:var(--gold); color:#000; border:none; border-radius:10px; font-weight:bold; cursor:pointer; width:100%;">
                            <i class="fas fa-sync"></i> توليد الخلاصة السريرية الشاملة
                        </button>
                    </div>

                    <div
                        style="background: rgba(212,175,55,0.05); padding: 30px; border-radius: 20px; border: 2px dashed var(--gold); position: relative;">
                        <div class="input-block">
                            <label style="font-size: 1.2rem; margin-bottom: 10px; color: var(--gold);">نص التشخيص
                                الختامي ومصل العلة:</label>
                            <textarea id="final-verdict-text" rows="10"
                                style="font-size: 1.1rem; border-color: var(--gold); background: rgba(0,0,0,0.2); color: #fff;"
                                placeholder="المعلم الخبير يدون هنا 'أصل العلة' والبروتوكول المقترح بناءً على تجميع بيانات الأنسجة والطبائع والفصائل والنبض والروح..."></textarea>
                        </div>

                        <!-- Expert Seal Placeholder -->
                        <div
                            style="display:flex; justify-content: space-between; align-items: flex-end; margin-top: 30px;">
                            <p style="color: #888; font-style: italic; font-size: 0.9rem;">* هذه الوثيقة تعتبر "تشخيصاً
                                بنيوياً" ولا تغني عن المراقبة السريرية المستمرة.</p>
                            <div id="expert-seal-box"
                                style="text-align: center; border: 2px solid var(--gold); padding: 10px; border-radius: 50%; width: 110px; height: 110px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; color: var(--gold); opacity: 0.8; transform: rotate(-15deg); font-weight: bold; line-height: 1.4;">
                                ختم الاعتماد<br><span id="seal-name">المعلم الخبير</span>
                            </div>
                        </div>
                    </div>

                    <!-- Archiving Action -->
                    <div style="margin-top: 30px; display: flex; gap: 15px;">
                        <button onclick="saveCurrentPatient()"
                            style="flex: 1; padding: 20px; background: #00ff99; color: #000; border: none; border-radius: 15px; font-weight: bold; cursor: pointer; font-size: 1.1rem; box-shadow: 0 10px 20px rgba(0,255,153,0.1);">
                            <i class="fas fa-cloud-arrow-up"></i> حفظ المريض في الأرشيف الدائم
                        </button>
                    </div>
                </section>

                <!-- Step 12: Archive Center -->
                <section class="diag-section" id="step-archive">
                    <h2 class="section-title"><i class="fas fa-box-archive"></i> مركز الأرشفة والتقارير المحفوظة</h2>
                    <div style="display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap;">
                        <input type="text" id="archive-search" oninput="renderArchive()"
                            placeholder="ابحث باسم المريض أو رقم السجل..."
                            style="flex: 1; min-width: 250px; padding: 15px; border-radius: 12px; background: rgba(255,255,255,0.05); border: 1px solid #444; color: #fff;">

                        <div style="display: flex; gap: 10px;">
                            <button onclick="exportArchive()" class="btn-premium"
                                style="background: var(--gold); color: #000; font-size: 0.85rem; padding: 10px 20px;">
                                <i class="fas fa-file-export"></i> تصدير (Backup)
                            </button>
                            <button onclick="document.getElementById('import-file').click()" class="btn-premium"
                                style="background: rgba(255,255,255,0.1); font-size: 0.85rem; padding: 10px 20px;">
                                <i class="fas fa-file-import"></i> استيراد
                            </button>
                            <input type="file" id="import-file" style="display:none" onchange="importArchive(event)">
                        </div>
                    </div>

                    <div id="archive-stats" style="margin-bottom: 20px; color: #888; font-size: 0.9rem;"></div>

                    <div id="archive-list-container"
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px;">
                        <!-- Populate dynamically -->
                    </div>
                </section>

                <div class="action-buttons">
                    <button class="btn-premium btn-prev" id="prevBtn" onclick="changeStep(-1)"><i
                            class="fas fa-arrow-right"></i> السابق</button>
                    <button class="btn-premium btn-next" id="nextBtn" onclick="changeStep(1)">التالي <i
                            class="fas fa-arrow-left"></i></button>
                </div>

            </main>
        </div>
    </div>

    <div class="expert-watermark">© 2026 الجامعة العالمية للطب الشمولي - حقوق المعلم الخبير محفوظة</div>

    <script>
        let currentStep = 1;

        function updateSeal() {
            const therapist = document.getElementById('therapist-name').value;
            const sealName = document.getElementById('seal-name');
            const sealBox = document.getElementById('expert-seal-box');

            if (therapist === 'leila') {
                sealName.innerText = 'د. ليلى سكاك';
                sealBox.style.borderColor = '#d4af37';
                sealBox.style.opacity = '1';
                sealBox.style.background = 'rgba(212,175,55,0.05)';
            } else if (therapist === 'ihsan') {
                sealName.innerText = 'د. إحسان حمدان';
                sealBox.style.borderColor = '#d4af37';
                sealBox.style.opacity = '1';
                sealBox.style.background = 'rgba(255,255,255,0.05)';
            } else {
                sealName.innerText = 'المعلم الخبير';
                sealBox.style.opacity = '0.4';
                sealBox.style.background = 'transparent';
            }
        }

        function generateFinalReport() {
            const summaryList = document.getElementById('evidence-summary-list');
            const therapist = document.getElementById('therapist-name').options[document.getElementById('therapist-name').selectedIndex].text;
            summaryList.innerHTML = ''; // Reset

            const analysisSources = [
                { id: 'blood-analysis-box', title: 'فصيلة الدم والأغذية', color: '#ff4d4d' },
                { id: 'humor-analysis-box', title: 'تحليل الأخلاط والطبائع', color: '#00d4ff' },
                { id: 'tissue-analysis-box', title: 'عمق الإصابة النسيجية', color: '#a29bfe' },
                { id: 'vital-analysis-box', title: 'الكفاءة الحيوية (الأيض)', color: '#00ff99' },
                { id: 'physical-analysis-box', title: 'التوازن الفيزيائي والوزن', color: '#f1c40f' },
                { id: 'pb-analysis-box', title: 'دلالات النبض والقارورة', color: '#ff6666' },
                { id: 'env-analysis-box', title: 'العوامل البيئية والزمانية', color: '#ff9933' },
                { id: 'tc-analysis-box', title: 'دلالات الطعوم والألوان', color: '#9b59b6' },
                { id: 'ps-analysis-box', title: 'الحالة النفسية والروحية', color: '#e056fd' },
                { id: 'step-11', title: 'الجهاز الهضمي', color: '#fdd835' },
                { id: 'step-12', title: 'الجهاز التنفسي', color: '#4fc3f7' },
                { id: 'step-13', title: 'الجهاز الدموي', color: '#ff5252' },
                { id: 'step-14', title: 'الجهاز العضلي', color: '#ff8a65' },
                { id: 'step-15', title: 'الغدة الدرقية', color: '#81c784' },
                { id: 'step-16', title: 'فحص النساء', color: '#f06292' },
                { id: 'step-17', title: 'فحص الرجال', color: '#64b5f6' },
                { id: 'step-18', title: 'الغدد والهرمونات', color: '#ba68c8' },
                { id: 'step-19', title: 'البرولاكتين', color: '#4db6ac' },
                { id: 'step-20', title: 'الجلطات', color: '#ef5350' },
                { id: 'step-21', title: 'الفحص السريري الشامل', color: '#90a4ae' }
            ];

            let hasData = false;
            analysisSources.forEach(src => {
                const box = document.getElementById(src.id);
                if (box && box.style.display !== 'none') {
                    hasData = true;
                    // Get the content div (usually next sibling or child)
                    const contentDiv = box.querySelector('div[id$="content"]');
                    if (contentDiv) {
                        const div = document.createElement('div');
                        div.className = 'evidence-block';
                        div.style.cssText = `background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; border-right: 4px solid ${src.color};`;
                        div.innerHTML = `<h5 style="color:${src.color}; margin-bottom:8px;"><i class="fas fa-circle-check"></i> ${src.title}:</h5><div style="font-size:0.85rem; opacity:0.9;">${contentDiv.innerHTML}</div>`;
                        summaryList.appendChild(div);
                    } else if (box && box.classList.contains('diag-section')) {
                        // Handle systematic check sections
                        const checkedItems = extractCheckedItems(src.id);
                        if (checkedItems) {
                            hasData = true;
                            const div = document.createElement('div');
                            div.className = 'evidence-block';
                            div.style.cssText = `background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; border-right: 4px solid ${src.color};`;
                            div.innerHTML = `<h5 style="color:${src.color}; margin-bottom:8px;"><i class="fas fa-circle-check"></i> ${src.title}:</h5><div style="font-size:0.85rem; opacity:0.9;">${checkedItems}</div>`;
                            summaryList.appendChild(div);
                        }
                    }
                }
            });

            if (!hasData) {
                summaryList.innerHTML = '<p style="color:#ff4757;"><i class="fas fa-triangle-exclamation"></i> عذراً، لم يتم العثور على أي تحليلات مكتملة في الأقسام السابقة. يرجى ملء البيانات أولاً.</p>';
            } else {
                // Generate a preliminary expert verdict hint
                const verdictArea = document.getElementById('final-verdict-text');
                const spiritualBox = document.getElementById('ps-analysis-box');
                const therapistSel = document.getElementById('therapist-name').value;
                const therapistName = (therapistSel === 'none') ? "المشرف" : document.getElementById('therapist-name').options[document.getElementById('therapist-name').selectedIndex].text;

                let hint = `بمراجعة وتصديق ${therapistName}، وبعد تجميع الأدلة، يتضح أن `;

                if (spiritualBox && spiritualBox.style.display !== 'none' && spiritualBox.innerHTML.includes('روحية')) {
                    hint += "العتلة ذات منشأ (روحي-نفسي) عميق يؤثر على الوظائف العضوية، ";
                } else {
                    hint += "العلة ذات منشأ (مادي-خلطي) ناتج عن انحراف المزاج، ";
                }

                hint += "ويوصى ببدء البروتوكول العلاجي بمضادات الخلط الغالب مع تعديل الغذاء والبيئة المحيطة.";
                verdictArea.value = hint;

                summaryList.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function showStep(s) {
            document.querySelectorAll('.diag-section').forEach(sec => sec.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));

            document.getElementById('step-' + s).classList.add('active');
            const navItem = document.querySelector(`.nav-item[data-step="${s}"]`);
            if (navItem) navItem.classList.add('active');

            currentStep = s;
            updateButtons();
        }

        function showHumorStep(step) {
            document.querySelectorAll('.humor-step').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.phase-container').forEach(p => p.classList.remove('active'));

            document.getElementById('hstep-' + step).classList.add('active');
            document.getElementById('humor-phase-' + step).classList.add('active');
        }

        function updateHumorAnalysis() {
            const checks = document.querySelectorAll('#step-3 input[type="checkbox"]:checked');

            let humors = { 'صفراوي': 0, 'دموي': 0, 'بلغمي': 0, 'سوداوي': 0 };
            let qualities = { 'حار': 0, 'بارد': 0, 'يابس': 0, 'رطب': 0 };

            checks.forEach(c => {
                const text = c.parentElement.innerText;
                if (text.includes('صفراوي')) humors['صفراوي']++;
                if (text.includes('سوداوي')) humors['سوداوي']++;
                if (text.includes('بلغمي')) humors['بلغمي']++;
                if (text.includes('دموي')) humors['دموي']++;
                if (text.includes('حار')) qualities['حار']++;
                if (text.includes('بارد')) qualities['بارد']++;
                if (text.includes('يابس')) qualities['يابس']++;
                if (text.includes('رطب')) qualities['رطب']++;
            });

            const box = document.getElementById('humor-analysis-box');
            const content = document.getElementById('humor-analysis-content');

            if (checks.length > 0) {
                box.style.display = 'block';

                // Sort humors by count
                let sortedHumors = Object.entries(humors)
                    .filter(h => h[1] > 0)
                    .sort((a, b) => b[1] - a[1]);

                let dominantText = sortedHumors.map(h => `${h[0]} (${h[1]} علامة)`).join(' + ');

                let html = `<p style="font-size:1.1rem; margin-bottom:15px; border-bottom:1px solid rgba(51,153,255,0.2); padding-bottom:10px;">
                                <strong>توليفة الخلط الغالب:</strong> <span style="color:#3399ff;">${dominantText}</span>
                            </p>`;

                // Temperature Analysis
                html += '<div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">';

                // Heat/Cold
                let tempIcon = qualities['حار'] >= qualities['بارد'] ? 'fa-fire' : 'fa-snowflake';
                let tempColor = qualities['حار'] >= qualities['بارد'] ? '#ff4d4d' : '#3399ff';
                let tempType = qualities['حار'] >= qualities['بارد'] ? 'ميل للحرارة' : 'ميل للبرودة';
                html += `<div style="background:rgba(255,255,255,0.03); padding:10px; border-radius:10px; border-right:3px solid ${tempColor};">
                            <i class="fas ${tempIcon}" style="color:${tempColor};"></i> <strong>المزاج الحركي:</strong> ${tempType} (${qualities['حار']}:${qualities['بارد']})
                         </div>`;

                // Dry/Moist
                let moistColor = qualities['يابس'] >= qualities['رطب'] ? varColor('gold') : '#00d4ff';
                let moistType = qualities['يابس'] >= qualities['رطب'] ? 'ميل لليبوسة' : 'ميل للرطوبة';
                html += `<div style="background:rgba(255,255,255,0.03); padding:10px; border-radius:10px; border-right:3px solid ${moistColor};">
                            <i class="fas fa-droplet" style="color:${moistColor};"></i> <strong>المزاج المادي:</strong> ${moistType} (${qualities['يابس']}:${qualities['رطب']})
                         </div>`;

                html += '</div>';

                html += `<p style="margin-top:10px; font-style:italic; color:#aaa; font-size:0.9rem;">
                            "التدبير يجب أن يتوجه للخلط الأكثر سيادة (الأول في القائمة) مع مراعاة تأثيرات الأعضاء الشريفة المتضررة."
                         </p>`;

                content.innerHTML = html;
            } else {
                box.style.display = 'none';
            }
        }

        // Helper function for CSS variables in JS
        function varColor(name) { return getComputedStyle(document.documentElement).getPropertyValue('--' + name).trim() || '#d4af37'; }

        function changeStep(n) {
            let next = currentStep + n;
            if (next >= 1 && next <= 22) {
                showStep(next);
            }
        }

        function updateButtons() {
            document.getElementById('prevBtn').style.visibility = (currentStep === 1) ? 'hidden' : 'visible';
            const nextBtn = document.getElementById('nextBtn');
            if (currentStep === 22) {
                nextBtn.innerHTML = 'إرسال التقرير النهائي <i class="fas fa-paper-plane"></i>';
            } else {
                nextBtn.innerHTML = 'التالي <i class="fas fa-arrow-left"></i>';
            }
        }

        function updatePhysicalAnalysis() {
            const w = parseFloat(document.getElementById('physical-weight').value);
            const h = parseFloat(document.getElementById('physical-height').value) / 100;
            const waist = parseFloat(document.getElementById('physical-waist').value);
            const checks = document.querySelectorAll('#step-6 input[type="checkbox"]:checked');
            const box = document.getElementById('physical-analysis-box');
            const content = document.getElementById('physical-analysis-content');

            if (w > 0 && h > 0) {
                box.style.display = 'block';
                let bmi = (w / (h * h)).toFixed(1);
                let status = "";
                let color = "";
                let holisticNote = "";

                if (bmi < 18.5) { status = "نقص وزن"; color = "#3399ff"; holisticNote = "غالباً ما يرتبط بالمزاج اليابس (سوداوي/صفراوي) ونقص المادة الرطبة المغذية."; }
                else if (bmi < 25) { status = "وزن مثالي"; color = "#00ff99"; holisticNote = "دليل على اعتدال القوة الغاذية وتوازن الأخلاط المادية."; }
                else if (bmi < 30) { status = "زيادة وزن"; color = "#ffcc00"; holisticNote = "بداية تراكم الأخلاط الرطبة (دموية أو بلغمية) التي تحتاج لتجفيف وتنقية."; }
                else { status = "سمنة مفرطة"; color = "#ff4d4d"; holisticNote = "احتقان خلطي شديد (غالباً بلغمي) يسبب 'ضيق النفس' وبرودة الحركية الحيوية."; }

                let html = `<div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; align-items:center;">
                                <div style="text-align:center; background:rgba(255,255,255,0.05); padding:15px; border-radius:15px;">
                                    <h2 style="color:${color}; font-size:2.5rem; margin:0;">${bmi}</h2>
                                    <p style="margin:0; color:${color}; font-weight:bold;">${status}</p>
                                </div>
                                <div>
                                    <p><strong>التحليل الشمولي:</strong> ${holisticNote}</p>
                                </div>
                            </div>`;

                if (waist > 100) {
                    html += `<p style="margin-top:15px; color:#ff4d4d; border-right:3px solid #ff4d4d; padding-right:10px;">
                                <i class="fas fa-triangle-exclamation"></i> <strong>تراكم الدهون الحشوي:</strong> محيط الخصر (${waist}سم) مرتفع؛ مما يشير لضغط على "الأعضاء الخدمية" في البطن وضعف حرارة الكبد.
                             </p>`;
                }

                if (checks.length > 0) {
                    html += `<p style="margin-top:10px; font-style:italic; color:#aaa;">الملاحظة البنيوية: تم رصد علامات ${Array.from(checks).map(c => c.parentElement.innerText.split('(')[0].trim()).join('، ')}.</p>`;
                }

                content.innerHTML = html;
            } else {
                box.style.display = 'none';
            }
        }

        function updatePsychoSpiritualAnalysis() {
            const checks = document.querySelectorAll('#step-10 input[type="checkbox"]:checked');
            const box = document.getElementById('ps-analysis-box');
            const content = document.getElementById('ps-analysis-content');

            if (checks.length > 0) {
                box.style.display = 'block';
                let neuro = 0;
                let spiritual = 0;
                let insights = [];

                checks.forEach(c => {
                    const text = c.parentElement.innerText;
                    if (text.includes('دوبامين') || text.includes('سيروتونين') || text.includes('كورتيزول') || text.includes('غدة') || text.includes('هرمونات')) neuro++;
                    else spiritual++;

                    if (text.includes('كورتيزول')) insights.push("<strong>تنبيه هرموني:</strong> فرط الكورتيزول يشير إلى استنزاف طاقة الكلى (الجوهر) وحاجة ماسة للاسترخاء.");
                    if (text.includes('سحر مأكول')) insights.push("<strong>إشارة روحية:</strong> السحر المأكول يحتاج لبرنامج تنقية للمعدة (القيء أو مسهلات) مع الرقية.");
                    if (text.includes('عين')) insights.push("<strong>إشارة روحية:</strong> وجود أعراض العين يستوجب 'الاغتسال' أو الرقية المركزة على خروج العرق والتثاؤب.");
                    if (text.includes('مس عاشق')) insights.push("<strong>إشارة روحية:</strong> المس العاشق غالباً ما يعيق المسارات الحيوية ويسبب ركوداً في منطقة الحوض.");
                });

                let html = `<p style="margin-bottom:15px;">تم رصد <strong>${neuro}</strong> مؤشرات عصبية/هرمونية و <strong>${spiritual}</strong> دلالات إصابة روحية.</p>`;

                if (insights.length > 0) {
                    html += '<ul style="list-style: none; padding: 0;">';
                    [...new Set(insights)].forEach(ins => { // Distinct insights
                        html += `<li style="margin-bottom:10px; border-right:3px solid #a29bfe; padding-right:12px;"><i class="fas fa-ghost" style="color:#a29bfe; margin-left:10px;"></i> ${ins}</li>`;
                    });
                    html += '</ul>';
                }

                let finalJudgement = "الحالة تحتاج لموازنة نفسية-بدنية.";
                if (spiritual > neuro) finalJudgement = "الإصابة الروحية هي 'المحرك الأساسي' للاعتلال البدني؛ الرقية مقدمة على الدواء.";
                else if (neuro > 0) finalJudgement = "الاضطراب العصب-هرموني عميق؛ يجب دعم النواقل العصبية بالأغذية والأعشاب المنشطة.";

                html += `<p style="margin-top:15px; background:rgba(162,155,254,0.1); padding:12px; border-radius:12px; border:1px dashed #a29bfe; font-weight:bold; color:#dcdde1;">
                            الخلاصة: ${finalJudgement}
                         </p>`;

                content.innerHTML = html;
            } else {
                box.style.display = 'none';
            }
        }

        function updateTasteColorAnalysis() {
            const checks = document.querySelectorAll('#step-9 input[type="checkbox"]:checked');
            const box = document.getElementById('tc-analysis-box');
            const content = document.getElementById('tc-analysis-content');

            if (checks.length > 0) {
                box.style.display = 'block';
                let insights = [];
                let tastes = [];
                let colors = [];

                checks.forEach(c => {
                    const val = c.value;
                    if (['sweet', 'bitter', 'salty', 'sour', 'pungent'].includes(val)) tastes.push(val);
                    else colors.push(val);
                });

                // Interpret Tastes
                if (tastes.includes('bitter')) insights.push("<strong>الميول للمرارة:</strong> علامة على حاجة الكبد للتنقية من خلط صفراوي محتقن.");
                if (tastes.includes('sweet')) insights.push("<strong>الميول للحلاوة:</strong> طلب لاإرادي لتوليد 'الروح' والدم، وقد يشير لضعف القوة الطاحنة.");
                if (tastes.includes('sour')) insights.push("<strong>الميول للحموضة:</strong> رغبة في قطع البلغم اللزج وتبريد حرارة المعدة.");
                if (tastes.includes('pungent')) insights.push("<strong>الميول للحرارة/الحريف:</strong> محاولة طبيعية من البدن لتحريك ركود بارد (بلغمي).");
                if (tastes.includes('salty')) insights.push("<strong>الميول للملوحة:</strong> قد تشير لجفاف في المادة (يبوسة) أو حاجة لتعديل رطوبة بلغمية.");

                // Interpret Colors
                if (colors.includes('red')) insights.push("<strong>الانجذاب للأحمر:</strong> يساهم في تنشيط الدورة الدموية وتحفيز القوة الغريزية.");
                if (colors.includes('blue')) insights.push("<strong>الانجذاب للأزرق:</strong> حاجة نفسية وبدنية للتبريد والسكينة من حميات أو حرارة.");
                if (colors.includes('dark')) insights.push("<strong>الميل للداكن:</strong> قد يشير لسيادة المزاج السوداوي والحاجة للخروج للضوء والألوان الحارة.");

                let html = '<ul style="list-style: none; padding: 0;">';
                insights.forEach(ins => {
                    html += `<li style="margin-bottom:10px; border-right:3px solid #9b59b6; padding-right:12px;"><i class="fas fa-palette" style="color:#9b59b6; margin-left:10px;"></i> ${ins}</li>`;
                });
                html += '</ul>';

                html += `<p style="margin-top:10px; color:#aaa; font-style:italic;">قاعدة: "النفس تشتهي ما يضاد علتها أو ما يشاكل خلطها الغالب لنفاده."</p>`;

                content.innerHTML = html;
            } else {
                box.style.display = 'none';
            }
        }

        function updateTimePlaceAnalysis() {
            const time = document.getElementById('env-time').value;
            const season = document.getElementById('env-season').value;
            const geo = document.getElementById('env-geo').value;
            const atmos = document.getElementById('env-atmos').value;
            const box = document.getElementById('env-analysis-box');
            const content = document.getElementById('env-analysis-content');

            box.style.display = 'block';
            let insights = [];

            // Season & Time Sync
            if (season === 'summer' && time === 'noon') insights.push("اجتماع 'وقت الظهيرة' مع 'فصل الصيف' يضاعف هيجان الصفراء؛ مما قد يسبب صداعاً حاداً أو جفافاً نسيجياً.");
            if (season === 'winter' && time === 'dawn') insights.push("الفجر في الشتاء هو ذروة 'البرد والرطوبة'؛ مما يضاعف احتقان الرئة وآلام المفاصل البلغمية.");
            if (time === 'evening') insights.push("وقت الغروب يحفز 'الخيال السوداوي'؛ فإذا كانت العلة تزداد في هذا الوقت فهي علة سوداوية المنشأ.");

            // Geo & Atmos Logic
            if (geo === 'sea' || atmos === 'humid') insights.push("المحيط الرطب (ساحلي/رطوبة) يمنع تحلل الفضلات عبر المسام، مما يزيد من ترسب البلغم في الأطراف.");
            if (geo === 'desert' || atmos === 'dry') insights.push("المحيط اليابس (صحراوي/جفاف) يسرع من احتراق الأخلاط، مما يتطلب ترطيباً بالمأكولات والمشروبات.");
            if (geo === 'mountain') insights.push("المناخ الجبلي البارد اليابس يحفز التقلص العضلي ويؤثر على المسارات العصبية.");
            if (geo === 'urban') insights.push("الوسط المدني يفرض 'أخلاطاً غريبة' (سموم)، مما يربك القوة المصلحة في الكبد.");

            let html = '<ul style="list-style: none; padding: 0;">';
            insights.forEach(ins => {
                html += `<li style="margin-bottom:10px; border-right:3px solid #ff9933; padding-right:12px;"><i class="fas fa-sun" style="color:#ff9933; margin-left:10px;"></i> ${ins}</li>`;
            });
            html += '</ul>';

            html += `<p style="margin-top:15px; background:rgba(255,153,51,0.08); padding:12px; border-radius:12px; font-style:italic; border:1px dashed #ff9933;">
                        التوجيه: "يجب تعديل الجدول اليومي للمريض بما يضاد تأثير هذا الزمان والمكان (القاعدة: العلاج بالضد)."
                     </p>`;

            content.innerHTML = html;
        }

        function updatePulseBottleAnalysis() {
            const pSize = document.getElementById('pulse-size').value;
            const pSpeed = document.getElementById('pulse-speed').value;
            const pTouch = document.getElementById('pulse-touch').value;
            const uColor = document.getElementById('urine-color').value;
            const uDensity = document.getElementById('urine-density').value;
            const box = document.getElementById('pb-analysis-box');
            const content = document.getElementById('pb-analysis-content');

            if (pSize !== 'normal' || pSpeed !== 'normal' || pTouch !== 'normal' || uColor !== 'straw' || uDensity !== 'normal') {
                box.style.display = 'block';
                let insights = [];

                // Pulse Logic
                if (pSize === 'large' || pSpeed === 'fast') insights.push("النبض يشير إلى 'ثوران' في الحرارة الغريزية واحتراق في الأخلاط الحارة.");
                if (pSize === 'small' || pSpeed === 'slow') insights.push("النبض المنخفض يشير إلى ركود بلغمي أو سوداوي وضعف القوة المحركة للقلب.");
                if (pTouch === 'hard') insights.push("صلابة النبض (اليبوسة) تدل على تضرر الأوعية بالأخلاط السوداوية الجافة.");

                // Urine Logic
                if (uColor === 'red' || uColor === 'yellow') insights.push("لون القارورة الناري/الأصفر يؤكد اشتعال المادة الصفراوية أو الدموية ونقص الترطيب.");
                if (uColor === 'white' && uDensity === 'thick') insights.push("كثافة وبياض القارورة دليل قطعي على عدم نضج الأخلاط وسيادة البلغم اللزج.");
                if (uColor === 'dark') insights.push("القوام الداكن (الكمد) من علامات ترسب السوداء العكرة وتطلب تقية سريعة للطحال والكبد.");
                if (uDensity === 'thin') insights.push("رقة القارورة (البول المائي) تعبر عن ضعف القوة الهاضمة في الكبد وعدم القدرة على فصل الفضلات.");

                let html = '<ul style="list-style: none; padding: 0;">';
                insights.forEach(ins => {
                    html += `<li style="margin-bottom:10px; border-right:3px solid #ff6666; padding-right:12px;"><i class="fas fa-heartbeat" style="color:#ff6666; margin-left:10px;"></i> ${ins}</li>`;
                });
                html += '</ul>';

                html += `<p style="margin-top:15px; background:rgba(255,102,102,0.08); padding:12px; border-radius:12px; font-style:italic; color:#ff9999;">
                            "يجب مقابلة شهادة النبض بشهادة القارورة؛ فإذا اجتمعا على الحرارة كان الحكم يقيناً."
                         </p>`;

                content.innerHTML = html;
            } else {
                box.style.display = 'none';
            }
        }

        function updateVitalAnalysis() {
            const ox = document.getElementById('vital-ox').value;
            const blood = document.getElementById('vital-blood').value;
            const checks = document.querySelectorAll('#step-5 input[type="checkbox"]:checked');
            const box = document.getElementById('vital-analysis-box');
            const content = document.getElementById('vital-analysis-content');

            box.style.display = 'block';
            let efficiency = 100;
            let insights = [];

            if (ox === 'low') { efficiency -= 20; insights.push("انخفاض الأكسجة يشير إلى ضعف في 'الروح الحيواني' وبطء في تجديد الأنسجة."); }
            if (ox === 'critical') { efficiency -= 40; insights.push("نقص الأكسجة الحاد علامة على ركود خلطي عميق يتطلب تحريكاً فورياً للدورة الدموية."); }

            if (blood === 'thick') { efficiency -= 15; insights.push("لزوجة الدم علامة على غلبة السوداء أو الدم المحترق، مما يزيد الجهد على القلب."); }
            if (blood === 'thin') { efficiency -= 15; insights.push("رقة الدم المائية تشير إلى سيادة البلغم وضعف القوة المصلحة."); }
            if (blood === 'dark') { efficiency -= 20; insights.push("لون الدم الداكن يشير إلى تراكم الأخلاط الرديئة واحتراق الصفراء."); }

            efficiency -= (checks.length * 5);
            if (efficiency < 0) efficiency = 5;

            let html = `<p style="font-size:1.2rem; margin-bottom:15px;"><strong>مؤشر الكفاءة الحيوية العام:</strong> <span style="color:#00ff99; font-weight:bold;">${efficiency}%</span></p>`;

            if (insights.length > 0) {
                html += '<ul style="list-style: none; padding: 0;">';
                insights.forEach(ins => {
                    html += `<li style="margin-bottom:8px; border-right:3px solid #00ff99; padding-right:10px;"><i class="fas fa-microscope" style="color:#00ff99; margin-left:8px;"></i> ${ins}</li>`;
                });
                html += '</ul>';
            }

            if (checks.length > 0) {
                html += `<p style="margin-top:10px; color:#ffcc00;"><i class="fas fa-exclamation-circle"></i> تم رصد ${checks.length} اختلالات في الميزان الكيميائي/المعدني تضعف القدرة الشفائية الذاتية.</p>`;
            }

            content.innerHTML = html;
        }

        function updateTissueAnalysis() {
            const checks = document.querySelectorAll('#step-4 input[type="checkbox"]:checked');
            const box = document.getElementById('tissue-analysis-box');
            const content = document.getElementById('tissue-analysis-content');

            if (checks.length > 0) {
                box.style.display = 'block';

                let results = { epithelial: 0, connective: 0, muscular: 0, nervous: 0 };

                checks.forEach(c => {
                    const groupTitle = c.closest('.organ-group').querySelector('h5').innerText;
                    if (groupTitle.includes('طلائية')) results.epithelial++;
                    if (groupTitle.includes('ضامة')) results.connective++;
                    if (groupTitle.includes('عضلية')) results.muscular++;
                    if (groupTitle.includes('عصبية')) results.nervous++;
                });

                let html = '<ul style="list-style: none; padding: 0;">';

                if (results.epithelial > 0) {
                    html += `<li style="margin-bottom:10px;"><i class="fas fa-check-circle" style="color:#00d4ff;"></i> <strong>المستوى السطحي:</strong> وجود ${results.epithelial} مؤشر على تأثر الأغشية والجلد، مما يرجح وجود سموم استقلابية في الوسط المحيط.</li>`;
                }
                if (results.connective > 0) {
                    html += `<li style="margin-bottom:10px;"><i class="fas fa-check-circle" style="color:#d4af37;"></i> <strong>المستوى البنيوي:</strong> وجود ${results.connective} مؤشر على تأثر الأنسجة الضامة، وهذا يستوجب فحص توازن الأملاح والوسط الحمضي/القاعدي للعظام.</li>`;
                }
                if (results.muscular > 0) {
                    html += `<li style="margin-bottom:10px;"><i class="fas fa-check-circle" style="color:#ff4d4d;"></i> <strong>المستوى الحركي:</strong> وجود ${results.muscular} مؤشر على إجهاد عضلي، غالباً ما يرتبط بنقص الأكسجة النسيجية أو اختلال الشوارد.</li>`;
                }
                if (results.nervous > 0) {
                    html += `<li style="margin-bottom:10px;"><i class="fas fa-check-circle" style="color:#a29bfe;"></i> <strong>المستوى العصبي:</strong> وجود ${results.nervous} مؤشر يُعد "إنذاراً حرجاً" لتأثر المركز العصبي، مما يتطلب تدخلاً مهدئاً وعميقاً للمسارات الكهربائية.</li>`;
                }

                html += '</ul>';

                // Final Holistic Conclusion
                let total = results.epithelial + results.connective + results.muscular + results.nervous;
                let depth = "سطحي";
                if (results.nervous > 0 || results.connective > 2) depth = "عميق وبنيوي";
                else if (results.muscular > 1) depth = "متوسط (أيضي)";

                html += `<p style="margin-top:15px; background:rgba(255,255,255,0.05); padding:10px; border-radius:10px; border-right:4px solid #a29bfe;">
                            <strong>الخلاصة البنيوية:</strong> العلة حالياً في مستوى <strong>[${depth}]</strong>. الترتيب العلاجي يجب أن يبدأ من الداخل (الأعصاب/العظام) إلى الخارج.
                         </p>`;

                content.innerHTML = html;
            } else {
                box.style.display = 'none';
            }
        }

        function extractCheckedItems(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return "";
            const checks = section.querySelectorAll('input[type="checkbox"]:checked');
            if (checks.length === 0) return "";
            return Array.from(checks).map(c => c.parentElement.innerText.trim()).join('، ');
        }

        // Placeholder update functions for new systemic sections
        function updateDigestiveAnalysis() { }
        function updateRespiratoryAnalysis() { }
        function updateCirculatoryAnalysis() { }
        function updateMuscularAnalysis() { }
        function updateThyroidAnalysis() { }
        function updateWomenAnalysis() { }
        function updateMenAnalysis() { }
        function updateEndocrineAnalysis() { }
        function updateProlactinAnalysis() { }
        function updateClotsAnalysis() { }
        function updateExamAnalysis() { }

        function selectCard(card, type) {
            // Unselect others in group
            card.parentElement.querySelectorAll('.diag-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');

            if (type === 'blood') updateBloodAnalysis();
        }

        const bloodData = {
            'A': {
                intro: 'الفصيلة A تتميز بجزيئات لكتين حساسة للبروتين الحيواني وحموضة معدية منخفضة طبيعياً.',
                symptoms: {
                    'حموضة في المعدة': 'ناتجة عن محاولة المعدة هضم لحوم ثقيلة بمستوى حمض ضعيف، مما يسبب تخمراً.',
                    'خمول بعد الأكل': 'استنشاد الطاقة الحيوية في مقاومة لكتينات الغذاء غير المتوافق.',
                    'تساقط شعر مفاجئ': 'سوء امتصاص المعادن بسبب التهاب معوي مزمن.',
                    'غازات وانتفاخات': 'عدم توافق مع الغلوتين أو البقوليات مما يسبب تهيجاً معوياً.',
                    'آلام مفاصل غير مبررة': 'تراكم اللكتينات في السوائل المفصلية مسبباً استجابة مناعية.',
                    'ضيق تنفس بعد وجبة': 'ارتفاع مؤقت في لزوجة الدم نتيجة دخول بروتينات غير مهضومة.',
                    'صداع نصفي متكرر': 'توسع الأوعية الدموية كرد فعل تحسسي لمواد مثل النيتريت في اللحوم المصنعة.',
                    'طفح جلدي أو حكة': 'محاولة الجسم تصريف السموم الغذائية عبر الجلد كعضو إخراج ثانوي.',
                    'إمساك أو إسهال مزمن': 'اضطراب في حركة الأمعاء الدودية نتيجة ضعف الأنزيمات الهاضمة.',
                    'اضطراب في النوم': 'ارتفاع الكورتيزول ليلاً كرد فعل للإجهاد الهضمي.',
                    'تقلبات مزاجية فجائية': 'ارتباط وثيق بين التهاب الجهاز الهضمي والناقلات العصبية (محور الأمعاء-الدماغ).',
                    'برودة في الأطراف': 'ضعف الدورة الدموية الدقيقة نتيجة لزوجة الدم الناتجة عن اللكتينات.',
                    'طنين في الأذن': 'اضطراب في الضغط الإسموزي للسوائل الداخلية نتيجة الحساسية الغذائية.',
                    'احتباس سوائل في الجسم': 'رد فعل دفاعي من الكلى لتركيز السموم الناتجة عن الغذاء غير المتوافق.',
                    'رغبة ملحة في السكريات': 'عدم كفاءة التمثيل الغذائي للكربوهيدرات المعقدة مما يطلب طاقة سريعة.'
                }
            },
            'O': {
                intro: 'الفصيلة O تمتلك حموضة عالية وجهازاً مناعياً قوياً، لكنها تتحسس بشدة من الحبوب والألبان.',
                symptoms: {
                    'حموضة في المعدة': 'زيادة مفرطة في إفراز حمض الهيدروليك أو تهيج من غلوتين القمح.',
                    'خمول بعد الأكل': 'رد فعل لارتفاع الأنسولين نتيحة تناول الكربوهيدرات (للأجسام الحارقة).',
                    'تساقط شعر مفاجئ': 'اضطراب الغدة الدرقية التي تتأثر بلتكينات الألبان والقمح.',
                    'غازات وانتفاخات': 'تأثير لكتينات البقوليات والحبوب على كفاءة القولون.',
                    'آلام مفاصل غير مبررة': 'تراكم حمض اليوريك أو التهاب ناتج عن الحساسية لكتينات الحبوب.',
                    'ضيق تنفس بعد وجبة': 'استجابة هيستامينية لبعض أنواع الكربوهيدرات المعقدة.',
                    'صداع نصفي متكرر': 'ناتج عن اختلال التوازن الأيوني بسبب استهلاك منتجات الألبان.',
                    'طفح جلدي أو حكة': 'تفاعل مناعي ناتج عن تسرب جزيئات القمح غير المهضومة للأنسجة الجلدية.',
                    'إمساك أو إسهال مزمن': 'عدم قدرة الأمعاء على التعامل مع الألياف الخشنة في بعض الحبوب.',
                    'اضطراب في النوم': 'زيادة النشاط الأيضي ليلاً بسبب تناول وجبات متأخرة تحتوي على كربوهيدرات.',
                    'تقلبات مزاجية فجائية': 'ارتباط مستويات الأدرينالين العالية بنوعية الوقود الغذائي المستهلك.',
                    'برودة في الأطراف': 'تقلص وعائي ناتج عن استجابة الجهاز العصبي الودي للمحسسات الغذائية.',
                    'طنين في الأذن': 'زيادة ضغط الدم الموضعي في الأوعية الدقيقة للأذن.',
                    'احتباس سوائل في الجسم': 'حساسية لكتينات معينة تسبب اضطراباً في توازن الصوديوم/بوتاسيوم.',
                    'رغبة ملحة في السكريات': 'حاجة الجسم لإعادة توازن الطاقة بعد استنزافها في هضم الحبوب.'
                }
            },
            'B': {
                intro: 'الفصيلة B تمتاز بمرونة بيولوجية، لكنها تتحسس من لكتينات الذرة، الدجاج، والسمسم.',
                symptoms: {
                    'حموضة في المعدة': 'اضطراب الوسط القاعدي نتيجة استهلاك الدواجن أو مواد مخمرة.',
                    'خمول بعد الأكل': 'هبوط سكر الدم الوهمي بسبب لكتينات الذرة أو العدس.',
                    'تساقط شعر مفاجئ': 'إجهاد جهازي يؤدي لنقص المغذيات الواصلة للبصيلات.',
                    'غازات وانتفاخات': 'عدم توازن البكتيريا النافعة بسبب السكريات غير المتوافقة.',
                    'آلام مفاصل غير مبررة': 'التهاب الأنسجة الضامة نتيجة عدم توازن الوسط الكيميائي.',
                    'ضيق تنفس بعد وجبة': 'تأثر النظام الوعائي ببروتينات الدجاج (الألبومين) لبعض الحالات.',
                    'صداع نصفي متكرر': 'حساسية للأمينات الموجودة في بعض الأغذية التي لا تناسب B.',
                    'طفح جلدي أو حكة': 'استجابة مناعية موضعية لكتينات المكسرات أو البذور غير المناسبة.',
                    'إمساك أو إسهال مزمن': 'خلل في الإفرازات المرارية اللازمة لهضم الدهون.',
                    'اضطراب في النوم': 'عدم انتظام مستويات السكر في الدم خلال الليل.',
                    'تقلبات مزاجية فجائية': 'تأثير لكتينات الذرة على مستويات الدوبامين في الدماغ.',
                    'برودة في الأطراف': 'استجابة عصبية تؤدي لبطء الدورة الدموية المحيطية.',
                    'طنين في الأذن': 'مرتبط أحياناً بحساسية الأذن الوسطى لمنتجات معينة.',
                    'احتباس سوائ في الجسم': 'ضعف كفاءة الجهاز الليمفاوي في تصريف الفضلات.',
                    'رغبة ملحة في السكريات': 'محاولة الدماغ التعويض عن نقص الجلوكوز الوظيفي.'
                }
            },
            'AB': {
                intro: 'الفصيلة AB تجمع بين تعقيد A ومرونة B، مما يجعل كيمياء جسمها دقيقة جداً ومزدوجة.',
                symptoms: {
                    'حموضة في المعدة': 'مزج بين نقص حمض A وحساسية B للحوم الحمراء.',
                    'خمول بعد الأكل': 'بطء شديد في الأيض أثناء التعامل مع اللكتينات المزدوجة.',
                    'تساقط شعر مفاجئ': 'ضعف امتصاص الزنك والحديد نتيجة التعقيد المعوي.',
                    'غازات وانتفاخات': 'تخمر ناتج عن نقص الكفاءة الإنزيمية المركبة.',
                    'آلام مفاصل غير مبررة': 'حساسية عالية للالتهابات الجهازي والسموم التراكمية.',
                    'ضيق تنفس بعد وجبة': 'تفاعل مناعي (تلازن) يسبب ضيقاً وعائياً مؤقتاً.',
                    'صداع نصفي متكرر': 'حساسية مركبة للمواد الكيميائية في الغذاء والبيئة.',
                    'طفح جلدي أو حكة': 'رد فعل مناعي مزدوج يظهر على الجلد كأداة تصريف.',
                    'إمساك أو إسهال مزمن': 'عدم استقرار البيئة البكتيرية في الأمعاء الغليظة.',
                    'اضطراب في النوم': 'نشاط ذهني زائد ناتج عن اختلال التوازن الكيميائي الحيوي.',
                    'تقلبات مزاجية فجائية': 'حساسية عالية جداً للمحفزات الغذائية المؤثرة على الجهاز العصبي.',
                    'برودة في الأطراف': 'ضعف الطاقة الحيوية الناتجة عن الأيض البطيء.',
                    'طنين في الأذن': 'تشنج الأوعية الدموية الدقيقة كرد فعل تحسسي.',
                    'احتباس سوائل في الجسم': 'تأثر التوازن المائي بالبروتينات المعقدة غير المهضومة.',
                    'رغبة ملحة في السكريات': 'نقص الوقود الخلوي الفوري للأعصاب والدماغ.'
                }
            }
        };

        let currentRh = '+';

        function selectRh(btn, value) {
            document.querySelectorAll('.rh-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentRh = value;
            updateBloodAnalysis();
        }

        function updateBloodAnalysis() {
            const selectedTypeCard = document.querySelector('.diag-cards .diag-card.selected');
            if (!selectedTypeCard) return;

            const type = selectedTypeCard.querySelector('h3').innerText.replace('فصيلة', '').trim();
            const checkedSymptoms = Array.from(document.querySelectorAll('#step-2 .traits-list input:checked'))
                .map(i => i.parentElement.innerText.trim());

            const box = document.getElementById('blood-analysis-box');
            const content = document.getElementById('analysis-content');

            if (checkedSymptoms.length > 0 && bloodData[type]) {
                box.style.display = 'block';
                let html = `<p style="margin-bottom:15px; border-bottom:1px solid rgba(212,175,55,0.2); padding-bottom:10px;"><strong>عزيزي المريض:</strong> التحليل لفصيلة <strong>${type}${currentRh}</strong> - ${bloodData[type].intro}</p>`;

                if (currentRh === '-') {
                    html += `<div style="background:rgba(212,175,55,0.1); padding:10px; border-radius:10px; margin-bottom:15px; border-right:3px solid var(--gold);">
                                <i class="fas fa-exclamation-triangle"></i> <strong>تنبيه الـ Rh السلبي:</strong> صاحب هذا الدم غالباً ما يمتلك جهازاً عصبياً "كهربائياً" أكثر حساسية للأدوية والمؤثرات المناخية، ويحتاج لجرعات غذائية دقيقة جداً.
                             </div>`;
                }

                html += '<ul style="list-style-type: none; padding: 0;">';
                checkedSymptoms.forEach(s => {
                    if (bloodData[type].symptoms[s]) {
                        html += `<li style="margin-bottom:10px;"><i class="fas fa-caret-left" style="color:var(--gold); margin-left:10px;"></i> <strong>${s}:</strong> ${bloodData[type].symptoms[s]}</li>`;
                    }
                });
                html += '</ul>';
                content.innerHTML = html;
            } else {
                box.style.display = 'none';
            }
        }

        // --- Part 2: Security & Hardware Integrity System ---
        function getFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const str = navigator.userAgent + screen.width + screen.height + navigator.hardwareConcurrency + navigator.language;
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) - hash) + str.charCodeAt(i);
                hash |= 0;
            }
            return "HWID-" + Math.abs(hash).toString(16).toUpperCase();
        }

        // Display Hardware ID on load
        const currentHWID = getFingerprint();
        setTimeout(() => {
            document.getElementById('hardware-id-display').innerText = currentHWID;
        }, 500);

        function verifyAccess() {
            const keyInput = document.getElementById('license-key').value.trim();
            const msg = document.getElementById('security-msg');

            // Corrected Master Keys
            const masterKey = "LEILA-2026-MASTER";
            const collabKey = "IHSAN-2026-COLLAB";

            // 1. Leila Access (The Owner)
            if (keyInput === masterKey) {
                unlockApp("أهلاً بك د. ليلى سكاك. تم التحقق من صلاحيات المالك.", true);
                return;
            }

            // 2. Ihsan Access (The Collaborator)
            if (keyInput === collabKey) {
                unlockApp("أهلاً بك د. إحسان حمدان. تم التحقق من صلاحيات الزميل.", true);
                return;
            }

            // 3. Patient/Single-Device Access Logic
            if (keyInput.startsWith("PATIENT-")) {
                const storedHWID = localStorage.getItem('authorized_hwid');
                const storedKey = localStorage.getItem('active_license_key');

                // Validation logic: Key must contain the second part of the current device HWID
                const expectedPatternPart = currentHWID.split('-')[1];
                if (!keyInput.includes(expectedPatternPart)) {
                    msg.innerText = "هذا الكود غير صالح لهذا الجهاز. يرجى مراجعة الطبيب.";
                    return;
                }

                if (!storedHWID) {
                    // First time activation on this device
                    localStorage.setItem('authorized_hwid', currentHWID);
                    localStorage.setItem('active_license_key', keyInput);
                    unlockApp("تم تفعيل اشتراكك بنجاح. هذا التطبيق مرتبط بجهازك حصرياً.", false);
                } else {
                    // Subsequent attempts
                    if (storedHWID === currentHWID && storedKey === keyInput) {
                        unlockApp("دخول آمن للمريض.", false);
                    } else if (storedHWID !== currentHWID) {
                        msg.innerText = "خطأ: هذا الكود مفعل بالفعل على جهاز آخر.";
                    } else {
                        msg.innerText = "كود التفعيل غير متطابق مع البيانات المسجلة.";
                    }
                }
            } else {
                msg.innerText = "كود ترخيص غير صالح. يرجى مراجعة المشرف.";
            }
        }

        function generateKeyForPatient() {
            const targetHWID = document.getElementById('target-hwid').value.trim();
            if (!targetHWID.includes('-')) {
                alert("يرجى إدخال Hardware ID صحيح للمريض");
                return;
            }
            const patientKey = "PATIENT-" + targetHWID.split('-')[1] + "-LIC-2026";
            document.getElementById('generated-key-display').innerText = patientKey;
        }

        let isCloudConnected = false;
        let db = null;

        // --- Part 0: Firebase Cloud Initialization (Bridge to Dr. Ihsan) ---
        // دكتورة ليلى: هنا تضعين بيانات حسابك في Firebase لاحقاً للربط الفعلي
        const firebaseConfig = {
            apiKey: "AIzaSyCNWSiw9p17h-kRiO9kFZKhxUJDDuM-wJw",
            authDomain: "holistic-medicine-5b0f8.firebaseapp.com",
            databaseURL: "https://holistic-medicine-5b0f8-default-rtdb.firebaseio.com",
            projectId: "holistic-medicine-5b0f8",
            storageBucket: "holistic-medicine-5b0f8.firebasestorage.app",
            messagingSenderId: "918937738606",
            appId: "1:918937738606:web:81c4ebcaaae6e3d9b8357f"
        };

        function initCloudSync() {
            if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                console.log("Cloud Sync: Placeholder keys detected. Local mode only.");
                return;
            }
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                isCloudConnected = true;
                document.getElementById('cloud-status').style.display = 'block';
                listenForCloudUpdates();
            } catch (err) {
                console.error("Cloud Connection Failed:", err);
            }
        }

        function listenForCloudUpdates() {
            if (!db) return;
            const archiveRef = db.ref('archive');
            archiveRef.on('value', (snapshot) => {
                const cloudData = snapshot.val();
                if (cloudData) {
                    const localArchive = JSON.parse(localStorage.getItem('holistic_archive') || '[]');
                    // Simple merge: Combine and deduplicate by ID
                    const cloudArray = Object.values(cloudData);
                    const merged = [...localArchive, ...cloudArray];
                    const unique = Array.from(new Map(merged.map(item => [item.id, item])).values());
                    localStorage.setItem('holistic_archive', JSON.stringify(unique));
                    if (document.getElementById('step-archive').classList.contains('active')) {
                        renderArchive();
                    }
                }
            });
        }

        function generateNewPatientID() {
            const now = new Date();
            const dateStr = now.getFullYear().toString() + (now.getMonth() + 1).toString().padStart(2, '0') + now.getDate().toString().padStart(2, '0');
            const randomStr = Math.random().toString(36).substring(2, 6).toUpperCase();
            const newID = `PAT-${dateStr}-${randomStr}`;
            const input = document.getElementById('patient-id-input');
            if (input) input.value = newID;
            return newID;
        }

        function unlockApp(welcomeMsg, isAdmin) {
            const shield = document.getElementById('security-shield');
            const archiveNav = document.getElementById('nav-archive');

            // Connect everyone to the cloud to allow data sync
            initCloudSync();

            if (isAdmin) {
                document.getElementById('admin-panel').style.display = 'flex';
                if (archiveNav) archiveNav.style.display = 'flex';
                const idBtn = document.getElementById('id-regen-btn');
                if (idBtn) idBtn.style.display = 'block';
            } else {
                if (archiveNav) archiveNav.style.display = 'none';
                const idBtn = document.getElementById('id-regen-btn');
                if (idBtn) idBtn.style.display = 'none';
            }

            // Generate first ID on unlock
            generateNewPatientID();

            shield.style.transition = '1.2s cubic-bezier(0.7, 0, 0.3, 1)';
            shield.style.opacity = '0';
            shield.style.transform = 'scale(1.1)';

            setTimeout(() => {
                shield.style.display = 'none';
                console.log(welcomeMsg);
            }, 1200);
        }

        // --- Part 3: Archiving System Logic ---
        function saveCurrentPatient() {
            const pId = document.getElementById('patient-id-input').value;
            const pName = document.querySelector('#step-1 .input-block:nth-child(2) input').value;

            if (!pName) {
                alert("يرجى إدخال اسم المريض على الأقل لحفظ السجل.");
                return;
            }

            const archive = JSON.parse(localStorage.getItem('holistic_archive') || '[]');

            // Capture all relevant inputs (Basic Info)
            const patientData = {
                id: pId || ('TEMP-' + Date.now()),
                saveDate: new Date().toLocaleString('ar-EG'),
                name: pName,
                therapist: document.getElementById('therapist-name').value,
                // We'll store the values of all inputs for simplicity
                inputs: {}
            };

            // Collect all inputs and selects
            document.querySelectorAll('input, select, textarea').forEach(el => {
                if (el.id) {
                    if (el.type === 'checkbox') patientData.inputs[el.id] = el.checked;
                    else patientData.inputs[el.id] = el.value;
                }
            });

            // Handle special components like selected blood type
            const selectedBlood = document.querySelector('.diag-cards .diag-card.selected');
            if (selectedBlood) patientData.inputs.selectedBloodType = selectedBlood.querySelector('h3').innerText;

            archive.push(patientData);
            localStorage.setItem('holistic_archive', JSON.stringify(archive));

            // Push to Cloud if connected
            if (isCloudConnected && db) {
                db.ref('archive/' + patientData.id.replace(/\W/g, '_')).set(patientData);
            }

            alert("تم حفظ بيانات المريض في الأرشيف بنجاح.");
        }

        function openArchive() {
            document.querySelectorAll('.diag-section').forEach(sec => sec.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.getElementById('step-archive').classList.add('active');
            renderArchive();
        }

        function renderArchive() {
            const container = document.getElementById('archive-list-container');
            const search = document.getElementById('archive-search').value.toLowerCase();
            const archive = JSON.parse(localStorage.getItem('holistic_archive') || '[]');
            const stats = document.getElementById('archive-stats');

            const filtered = archive.filter(p => p.name.toLowerCase().includes(search) || p.id.toLowerCase().includes(search));
            stats.innerText = `عدد الحالات المؤرشفة: ${filtered.length}`;
            container.innerHTML = '';

            filtered.reverse().forEach((p, index) => {
                const card = document.createElement('div');
                card.style.cssText = `background: rgba(255,255,255,0.03); border: 1px solid rgba(212,175,55,0.2); padding: 20px; border-radius: 20px; transition: 0.3s;`;
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                        <span style="color:var(--gold); font-size:0.8rem;">${p.id}</span>
                        <span style="color:#666; font-size:0.75rem;">${p.saveDate}</span>
                    </div>
                    <h4 style="color:#fff; margin-bottom:10px;">${p.name}</h4>
                    <p style="color:#888; font-size:0.85rem; margin-bottom:15px;">المعالج: ${p.therapist === 'leila' ? 'د. ليلى سكاك' : 'د. إحسان حمدان'}</p>
                    <div style="display:flex; gap:10px;">
                        <button onclick="loadPatientData('${p.id}')" style="flex:1; padding:8px; background:rgba(212,175,55,0.1); border:1px solid var(--gold); color:var(--gold); border-radius:8px; cursor:pointer; font-size:0.8rem;">استرجاع البيانات</button>
                        <button onclick="deleteRecord('${p.id}')" style="padding:8px; background:rgba(255,71,87,0.1); border:1px solid #ff4757; color:#ff4757; border-radius:8px; cursor:pointer;"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function loadPatientData(id) {
            const archive = JSON.parse(localStorage.getItem('holistic_archive') || '[]');
            const p = archive.find(item => item.id === id);
            if (!p) return;

            // Restore inputs
            for (const key in p.inputs) {
                const el = document.getElementById(key);
                if (el) {
                    if (el.type === 'checkbox') el.checked = p.inputs[key];
                    else el.value = p.inputs[key];
                }
            }

            // Logic to re-select blood type card if any
            if (p.inputs.selectedBloodType) {
                document.querySelectorAll('.diag-cards .diag-card h3').forEach(h3 => {
                    if (h3.innerText === p.inputs.selectedBloodType) h3.parentElement.click();
                });
            }

            alert(`تم استرجاع بيانات المريض: ${p.name}`);
            showStep(1); // Go back to start

            // Trigger all analysis updates
            updateBloodAnalysis();
            updateHumorAnalysis();
            updateVitalAnalysis();
            updatePulseBottleAnalysis();
            updateTimePlaceAnalysis();
            updateTasteColorAnalysis();
            updatePsychoSpiritualAnalysis();
            updateSeal();
        }

        function deleteRecord(id) {
            if (confirm("هل أنت متأكد من رغبتك في حذف هذا السجل نهائياً؟")) {
                let archive = JSON.parse(localStorage.getItem('holistic_archive') || '[]');
                archive = archive.filter(p => p.id !== id);
                localStorage.setItem('holistic_archive', JSON.stringify(archive));
                renderArchive();
            }
        }

        function exportArchive() {
            const archive = localStorage.getItem('holistic_archive') || '[]';
            const blob = new Blob([archive], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `archive_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function importArchive(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (Array.isArray(imported)) {
                        const existing = JSON.parse(localStorage.getItem('holistic_archive') || '[]');
                        const merged = [...existing, ...imported];
                        // Deduplicate by ID
                        const unique = Array.from(new Map(merged.map(item => [item.id, item])).values());
                        localStorage.setItem('holistic_archive', JSON.stringify(unique));
                        alert("تم استيراد الأرشيف بنجاح ودمجه مع البيانات الحالية.");
                        renderArchive();
                    }
                } catch (err) {
                    alert("خطأ في قراءة ملف الأرشيف.");
                }
            };
            reader.readAsText(file);
        }

        // --- Part 4: Multi-Language (i18n) Engine ---
        const translations = {
            ar: {
                app_title: "نظام التشخيص الشمولي الموسع",
                academic_supervisor: "المشرف الأكاديمي: د. إحسان حمدان | الإصدار الاحترافي 2026",
                print_report: "طباعة التقرير",
                nav_basic: "الحالة",
                nav_blood: "الفصائل الدموية",
                nav_humors: "نظام الطبائع",
                nav_tissue: "تشخيص الأنسجة",
                nav_vital: "التشخيص الحيوي",
                nav_balance: "التوازن الفيزيائي",
                nav_pulse: "القارورة والنبض",
                nav_time: "الزمان والمكان",
                nav_taste: "الطعوم والألوان",
                nav_psycho: "النفس والروح",
                nav_digestive: "الجهاز الهضمي",
                nav_respiratory: "الجهاز التنفسي",
                nav_circulatory: "الجهاز الدموي",
                nav_muscular: "الجهاز العضلي",
                nav_thyroid: "الغدة الدرقية",
                nav_women: "فحص النساء",
                nav_men: "فحص الرجال",
                nav_endocrine: "الغدد والهرمونات",
                nav_prolactin: "البرولاكتين",
                nav_clots: "الجلطات",
                nav_exam: "فحص سريري شامل",
                nav_asl: "مصدر العلة",
                nav_archive: "مركز الأرشيف المنظم",
                btn_prev: "السابق",
                btn_next: "التالي",
                rec_id: "رقم السجل (آلي)",
                patient_name: "اسم المريض",
                therapist_name: "اسم المعالج المشرف",
                gender: "الجنس",
                age: "العمر الفعلي",
                weight: "الوزن",
                height: "الطول",
                male: "ذكر",
                female: "أنثى"
            },
            en: {
                app_title: "Extended Holistic Diagnostic System",
                academic_supervisor: "Academic Supervisor: Dr. Ihsan Hamdan | Pro Edition 2026",
                print_report: "Print Report",
                nav_basic: "Status",
                nav_blood: "Blood Types",
                nav_humors: "Temperaments System",
                nav_tissue: "Tissue Diagnosis",
                nav_vital: "Vital Diagnosis",
                nav_balance: "Physical Balance",
                nav_pulse: "Vial & Pulse",
                nav_time: "Time & Space",
                nav_taste: "Tastes & Colors",
                nav_psycho: "Mind & Soul",
                nav_digestive: "Digestive System",
                nav_respiratory: "Respiratory System",
                nav_circulatory: "Circulatory System",
                nav_muscular: "Muscular System",
                nav_thyroid: "Thyroid Gland",
                nav_women: "Women's Health",
                nav_men: "Men's Health",
                nav_endocrine: "Hormones",
                nav_prolactin: "Prolactin",
                nav_clots: "Blood Clots",
                nav_exam: "Full Clinical Exam",
                nav_asl: "Source of Ailment",
                nav_archive: "Organized Archive",
                btn_prev: "Previous",
                btn_next: "Next",
                rec_id: "Record ID (Auto)",
                patient_name: "Patient Name",
                therapist_name: "Supervising Healer",
                gender: "Gender",
                age: "Actual Age",
                weight: "Weight",
                height: "Height",
                male: "Male",
                female: "Female"
            },
            fr: {
                app_title: "Système de Diagnostic Holistique étendu",
                academic_supervisor: "Superviseur Académique: Dr Ihsan Hamdan | Édition Pro 2026",
                print_report: "Imprimer le rapport",
                nav_basic: "Statut",
                nav_blood: "Groupes Sanguins",
                nav_humors: "Système des Tempéraments",
                nav_tissue: "Diagnostic des Tissus",
                nav_vital: "Diagnostic Vital",
                nav_balance: "Équilibre Physique",
                nav_pulse: "Fiole & Pouls",
                nav_time: "Temps & Espace",
                nav_taste: "Goûts & Couleurs",
                nav_psycho: "Âme & Esprit",
                nav_digestive: "Système Digestif",
                nav_respiratory: "Système Respiratoire",
                nav_circulatory: "Système Circulatoire",
                nav_muscular: "Système Musculaire",
                nav_thyroid: "Glande Thyroïde",
                nav_women: "Santé des Femmes",
                nav_men: "Santé des Hommes",
                nav_endocrine: "Hormones",
                nav_prolactin: "Prolactine",
                nav_clots: "Caillots Sanguins",
                nav_exam: "Examen Clinique Complet",
                nav_asl: "Source du Mal",
                nav_archive: "Centre d'Archives",
                btn_prev: "Précédent",
                btn_next: "Suivant",
                rec_id: "ID Registre (Auto)",
                patient_name: "Nom du Patient",
                therapist_name: "Guérisseur Superviseur",
                gender: "Sexe",
                age: "Âge Actuel",
                weight: "Poids",
                height: "Taille",
                male: "Masculin",
                female: "Féminin"
            }
        };

        function changeLanguage(lang) {
            const t = translations[lang];
            if (!t) return;

            // Update direction and font
            if (lang === 'ar') {
                document.body.dir = 'rtl';
                document.body.style.fontFamily = "'Amiri', serif";
            } else {
                document.body.dir = 'ltr';
                document.body.style.fontFamily = "'Inter', sans-serif";
            }

            // Update elements with data-i18n
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) {
                    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        el.placeholder = t[key];
                    } else {
                        el.textContent = t[key];
                    }
                }
            });

            // Update Navigation Titles specifically (to keep icons)
            document.querySelectorAll('.nav-item').forEach(item => {
                const step = item.getAttribute('data-step');
                const icon = item.querySelector('i');
                if (step) {
                    const keys = ['', 'nav_basic', 'nav_blood', 'nav_humors', 'nav_tissue', 'nav_vital', 'nav_balance', 'nav_pulse', 'nav_time', 'nav_taste', 'nav_psycho', 'nav_digestive', 'nav_respiratory', 'nav_circulatory', 'nav_muscular', 'nav_thyroid', 'nav_women', 'nav_men', 'nav_endocrine', 'nav_prolactin', 'nav_clots', 'nav_exam', 'nav_asl'];
                    const textContent = t[keys[step]];
                    if (textContent) {
                        item.innerHTML = '';
                        if (icon) item.appendChild(icon);
                        item.appendChild(document.createTextNode(' ' + textContent));
                    }
                }
            });

            // Special cases for buttons
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            if (prevBtn) prevBtn.innerHTML = `<i class="fas fa-arrow-${lang === 'ar' ? 'right' : 'left'}"></i> ` + t.btn_prev;
            if (nextBtn) nextBtn.innerHTML = t.btn_next + ` <i class="fas fa-arrow-${lang === 'ar' ? 'left' : 'right'}"></i>`;
        }

        // Initial setup
        updateButtons();
    </script>
</body>

</html>